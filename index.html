<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kho Dao</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root{--blue:#1976d2;--orange:#ff9800;--red:#d32f2f;--bg:#f4f6f8;}
body{font-family:Segoe UI,Arial;background:var(--bg);margin:20px}
h1{margin-bottom:10px}
button{padding:8px 14px;border:0;border-radius:6px;cursor:pointer;display:inline-flex;gap:6px;align-items:center}
.primary{background:var(--blue);color:#fff}
.warn{background:var(--orange);color:#fff}
.small{padding:6px 10px;font-size:13px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
th,td{padding:9px;border-bottom:1px solid #eee;font-size:14px}
th{background:var(--blue);color:#fff}
.low{color:var(--red);font-weight:700}
.actions{display:flex;gap:5px}
.toolbar,.filter{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
input,select{padding:7px;border-radius:6px;border:1px solid #ccc}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000}
.box{background:#fff;padding:20px;border-radius:12px;width:420px}
ul{padding-left:18px}

@media (max-width:768px){
body{margin:10px}
h1{font-size:20px}
table,thead,tbody,th,td,tr{display:block}
thead{display:none}
tr{background:#fff;border-radius:10px;margin-bottom:10px;padding:10px}
td{border:none;padding:4px 0;font-size:13px}
td::before{content:attr(data-label);font-weight:600;color:#555}
.actions{flex-wrap:wrap}
.modal .box{width:95%;max-height:85vh;overflow:auto}
input,select{width:100%}
}
</style>
</head>

<body>

<h1><i class="fa-solid fa-warehouse"></i> Kho Dao</h1>

<div class="toolbar">
<button class="primary" onclick="openPass()"><i class="fa fa-lock"></i> Đăng nhập</button>
<button class="primary" onclick="toggleForm()"><i class="fa fa-plus"></i> Thêm sản phẩm</button>

<button onclick="exportJSON()"><i class="fa fa-download"></i> Xuất JSON</button>
<input type="file" id="importJSON" hidden accept=".json" onchange="importJSONFile(event)">
<button onclick="importJSON.click()"><i class="fa fa-upload"></i> Nhập JSON</button>

<button class="warn" onclick="saveOnline()"><i class="fa fa-cloud-upload"></i> Lưu online</button>

<select id="pdfMonth"></select>
<select id="pdfYear"></select>
<button class="warn" onclick="exportPDF()"><i class="fa fa-file-pdf"></i> PDF nhập / xuất</button>
<button class="warn" onclick="exportFullStockPDF()"><i class="fa fa-file-pdf"></i> PDF toàn bộ kho</button>
<button class="warn" onclick="clearAllHistory()"><i class="fa fa-trash"></i> Xóa toàn bộ lịch sử</button>
</div>

<div class="filter">
<select id="f_category"><option value="">Loại</option><option>dao cắt</option><option>dao răng</option><option>dao</option></select>
<select id="f_size"><option value="">Size</option><option>0.7</option><option>1.05</option><option>1.42</option></select>
<select id="f_leg"><option value="">Chân</option><option>có chân</option><option>không chân</option></select>
<select id="f_blade"><option value="">Đầu</option><option>lưỡi tròn</option><option>lưỡi bằng</option><option>lưỡi bầu</option><option>lưỡi nhọn</option></select>
<select id="f_origin"><option value="">Xuất xứ</option><option>Nhật</option><option>Trung Quốc</option></select>
<select id="f_stock"><option value="">Số lượng</option><option value="low">Tồn thấp</option><option value="zero">Hết hàng</option></select>
</div>

<table>
<thead>
<tr>
<th>Tên</th><th>Loại</th><th>Size</th><th>Chân</th>
<th>Đầu</th><th>Xuất xứ</th><th>SL</th><th>Hành động</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<!-- MODALS -->
<div class="modal" id="passModal"><div class="box">
<input type="password" id="pass" placeholder="Mật khẩu">
<button class="primary" onclick="login()">Xác nhận</button>
</div></div>

<div class="modal" id="ioModal"><div class="box">
<h3 id="ioTitle"></h3>
<input id="ioQty" type="number" placeholder="Số lượng">
<button class="warn" onclick="submitIO()">Xác nhận</button>
</div></div>

<div class="modal" id="editModal"><div class="box">
<input id="e_name">
<select id="e_category"></select>
<select id="e_size"></select>
<select id="e_leg"></select>
<select id="e_blade"></select>
<select id="e_origin"></select>
<input id="e_qty" type="number">
<div class="actions">
<button class="primary" onclick="saveEdit()">Lưu</button>
<button class="warn" onclick="deleteProduct()">Xóa</button>
</div>
</div></div>

<div class="modal" id="historyModal"><div class="box">
<h3>Lịch sử nhập / xuất</h3>
<ul id="historyList"></ul>
</div></div>

<script>
/* ===== ONLINE CONFIG ===== */
const GITHUB_TOKEN="DAN_TOKEN_CUA_BAN";
const GIST_ID="GIST_ID_CUA_BAN";
const GIST_FILE="kho_dao.json";

/* ===== CORE ===== */
const PASSWORD="kgget1234",LOW_STOCK=5;
let hasAccess=false,editIndex=-1,ioIndex=-1,ioType="",historyIndex=-1;
const products=JSON.parse(localStorage.getItem("products")||"[]");

/* ===== INIT ===== */
const now=new Date();
for(let m=0;m<12;m++)pdfMonth.innerHTML+=`<option value="${m}">${m+1}</option>`;
for(let y=now.getFullYear()-2;y<=now.getFullYear();y++)pdfYear.innerHTML+=`<option>${y}</option>`;
pdfMonth.value=now.getMonth();pdfYear.value=now.getFullYear();

/* ===== LOGIN ===== */
function openPass(){passModal.style.display="flex"}
function login(){pass.value===PASSWORD?(hasAccess=true,passModal.style.display="none",alert("Đăng nhập thành công")):alert("Sai mật khẩu")}

/* ===== ONLINE SAVE ===== */
async function saveOnline(){
await fetch(`https://api.github.com/gists/${GIST_ID}`,{
method:"PATCH",
headers:{
"Authorization":"token "+GITHUB_TOKEN,
"Content-Type":"application/json"
},
body:JSON.stringify({files:{[GIST_FILE]:{content:JSON.stringify(products,null,2)}}})
});
}

/* ===== REALTIME SYNC LEVEL 1 ===== */
let lastOnlineUpdate=null;
setInterval(async()=>{
try{
const r=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{Authorization:"token "+GITHUB_TOKEN}});
const d=await r.json();
if(lastOnlineUpdate&&d.updated_at<=lastOnlineUpdate)return;
const online=d.files[GIST_FILE].content;
if(online!==localStorage.getItem("products")){
localStorage.setItem("products",online);
lastOnlineUpdate=d.updated_at;
render();
}
}catch(e){}
},5000);

/* ===== CORE LOGIC (GIỮ NGUYÊN) ===== */
function toggleForm(){if(!hasAccess)return alert("Vui lòng đăng nhập")}
function addProduct(){products.push({name:name.value,category:category.value,size:size.value,leg:leg.value,blade:blade.value,origin:origin.value,quantity:+qty.value,history:[],createdAt:new Date().toISOString()});save()}
function openIO(i,t){ioIndex=i;ioType=t;ioTitle.innerText=t==="nhap"?"Nhập":"Xuất";ioModal.style.display="flex"}
function submitIO(){const p=products[ioIndex],q=+ioQty.value;if(q<=0)return;if(ioType==="xuat"&&q>p.quantity)return;p.quantity+=ioType==="nhap"?q:-q;p.history.push({type:ioType,qty:q,date:new Date().toISOString()});save();ioModal.style.display="none"}
function viewHistory(i){historyIndex=i;historyList.innerHTML=products[i].history.map(h=>`<li>${h.type} ${h.qty}</li>`).join("");historyModal.style.display="flex"}
function save(){localStorage.setItem("products",JSON.stringify(products));render();saveOnline()}
function render(){tbody.innerHTML="";products.forEach((p,i)=>{tbody.innerHTML+=`<tr><td>${p.name}</td><td>${p.category}</td><td>${p.size}</td><td>${p.leg}</td><td>${p.blade}</td><td>${p.origin}</td><td>${p.quantity}</td><td><button onclick="openIO(${i},'nhap')">+</button><button onclick="openIO(${i},'xuat')">-</button></td></tr>`})}
render();
</script>

</body>
</html>
