<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‚è±Ô∏è Ch·∫•m C√¥ng TƒÉng Ca</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23007AFF' d='M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23007AFF' d='M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',-apple-system,sans-serif;}
        :root{--primary:#007AFF;--success:#34C759;--warning:#FF9500;--danger:#FF3B30;--light:#F2F2F7;--dark:#1D1D1F;--gray:#8E8E93;--border:#C7C7CC;--card-bg:#FFFFFF;--sunday:#FF2D55;--salary:#5856D6;--toggle-on:#34C759;--toggle-off:#E5E5EA;}
        body{background-color:var(--light);color:var(--dark);line-height:1.5;max-width:100%;overflow-x:hidden;padding-bottom:env(safe-area-inset-bottom);-webkit-tap-highlight-color:transparent;-webkit-text-size-adjust:100%;}
        .header{background:linear-gradient(135deg,var(--primary),#5856D6);color:white;padding-top:max(env(safe-area-inset-top), 15px);padding-bottom:20px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
        .header-content{padding:15px 20px;}
        .header h1{font-size:24px;font-weight:700;margin-bottom:5px;}
        .header p{opacity:0.9;font-size:14px;font-weight:400;}
        .current-time{background-color:var(--card-bg);margin:15px;padding:15px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);text-align:center;}
        .current-time h2{font-size:18px;margin-bottom:10px;color:var(--primary);display:flex;align-items:center;justify-content:center;gap:10px;}
        .time-display{font-size:32px;font-weight:700;color:var(--dark);margin:10px 0;}
        .date-display{font-size:16px;color:var(--gray);font-weight:500;}
        .day-indicator{display:inline-flex;align-items:center;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;margin-top:8px;background-color:rgba(255,255,255,0.2);}
        .day-indicator.sunday{background-color:var(--sunday);}
        .container{max-width:100%;padding:0 15px 20px;}
        .card{background-color:var(--card-bg);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
        .card h2{font-size:18px;margin-bottom:15px;color:var(--dark);display:flex;align-items:center;gap:10px;}
        .card h2 i{color:var(--primary);}
        .controls{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;}
        .btn{background-color:var(--primary);color:white;border:none;border-radius:12px;padding:16px 10px;font-size:17px;font-weight:600;text-align:center;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none;}
        .btn:active{transform:scale(0.97);}
        .btn-full{width:100%;}
        .btn-start{background-color:var(--success);}
        .btn-start:active{background-color:#2DAE4A;}
        .btn-start.auto-activated{background-color:#2DAE4A;border:2px solid #1E8C3E;}
        .btn-end{background-color:var(--warning);}
        .btn-end:active{background-color:#E68500;}
        .btn-overtime{background-color:#AF52DE;margin-top:10px;}
        .btn-overtime:active{background-color:#9B45C7;}
        .btn-salary-control{background:linear-gradient(135deg,var(--salary),#7D3CFF);margin-top:10px;grid-column:span 2;animation:pulse 2s infinite;}
        @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.02);}100%{transform:scale(1);}}
        .btn-salary-control:active{transform:scale(0.97);animation:none;}
        .btn-small{padding:10px 15px;font-size:14px;border-radius:10px;}
        .btn-secondary{background-color:var(--light);color:var(--dark);border:1px solid var(--border);}
        .btn-secondary:active{background-color:#E5E5EA;}
        .btn-month{background-color:#5AC8FA;margin-top:15px;}
        .btn-month:active{background-color:#4AA8D8;}
        .btn-lunch{background-color:#FF9500;margin-top:10px;}
        .btn-lunch:active{background-color:#E68500;}
        .btn-salary{background-color:var(--salary);margin-top:10px;}
        .btn-salary:active{background-color:#4A4AC8;}
        .btn-backup{background-color:#FF9500;margin-top:10px;}
        .btn-backup:active{background-color:#E68500;}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none !important;}
        .auto-start-info{background-color:rgba(52,199,89,0.1);border-radius:10px;padding:12px;margin-top:10px;text-align:center;font-size:14px;color:var(--success);display:flex;align-items:center;justify-content:center;gap:8px;}
        .auto-start-info i{font-size:16px;}
        .work-info{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}
        .info-box{background-color:var(--light);border-radius:12px;padding:15px;text-align:center;}
        .info-box h3{font-size:14px;color:var(--gray);margin-bottom:5px;font-weight:500;}
        .info-value{font-size:20px;font-weight:700;color:var(--dark);}
        .info-unit{font-size:14px;color:var(--gray);margin-left:2px;}
        .expected-salary{background-color:rgba(88,86,214,0.1);border-radius:12px;padding:15px;margin-top:15px;text-align:center;border:2px solid var(--salary);}
        .expected-salary h4{color:var(--salary);margin-bottom:5px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;}
        .expected-amount{font-size:22px;font-weight:700;color:var(--salary);}
        .work-history{max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
        .history-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid var(--light);}
        .history-item:last-child{border-bottom:none;}
        .history-date{font-weight:600;font-size:16px;color:var(--dark);}
        .history-time{font-size:14px;color:var(--gray);}
        .history-overtime{font-weight:700;font-size:16px;color:var(--success);}
        .delete-section{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
        .month-select{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background-color:white;font-size:16px;margin-right:10px;}
        .footer{text-align:center;padding:20px;color:var(--gray);font-size:14px;border-top:1px solid var(--border);margin-top:10px;}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;padding:20px;overflow-y:auto;}
        .modal-content{background-color:white;border-radius:16px;padding:25px;width:100%;max-width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.2);max-height:90vh;overflow-y:auto;}
        .modal h3{font-size:20px;margin-bottom:15px;color:var(--dark);display:flex;align-items:center;justify-content:space-between;}
        .modal h3 .close-btn{background:none;border:none;color:var(--gray);font-size:24px;cursor:pointer;padding:0;}
        .modal p{margin-bottom:20px;color:var(--gray);line-height:1.6;}
        .modal-buttons{display:flex;gap:10px;margin-top:20px;}
        .calendar{width:100%;}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .calendar-month-year{font-size:18px;font-weight:600;color:var(--dark);}
        .calendar-nav{display:flex;gap:10px;}
        .calendar-nav-btn{background-color:var(--light);border:none;border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:10px;text-align:center;font-weight:600;font-size:14px;color:var(--gray);}
        .calendar-weekdays div{padding:8px 0;}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;font-size:16px;font-weight:500;cursor:pointer;transition:all 0.2s;position:relative;}
        .calendar-day:hover{background-color:var(--light);}
        .calendar-day.empty{background-color:transparent;cursor:default;}
        .calendar-day.today{background-color:rgba(0,122,255,0.1);color:var(--primary);font-weight:700;}
        .calendar-day.has-data{background-color:rgba(52,199,89,0.1);}
        .calendar-day.sunday{color:var(--sunday);}
        .calendar-day.selected{background-color:var(--primary);color:white;}
        .day-overtime{font-size:10px;margin-top:2px;color:var(--success);font-weight:700;}
        .day-lunch{position:absolute;top:2px;right:2px;width:6px;height:6px;background-color:var(--warning);border-radius:50%;}
        .day-detail{margin-bottom:20px;}
        .day-detail-info{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}
        .detail-box{background-color:var(--light);border-radius:12px;padding:15px;text-align:center;}
        .detail-box h4{font-size:14px;color:var(--gray);margin-bottom:5px;font-weight:500;}
        .detail-value{font-size:18px;font-weight:700;color:var(--dark);}
        .edit-time{display:flex;gap:10px;margin-bottom:15px;align-items:center;}
        .time-input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background-color:white;font-size:16px;text-align:center;}
        .edit-overtime{margin-bottom:15px;}
        .edit-overtime label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);}
        .overtime-input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background-color:white;font-size:16px;text-align:center;}
        .edit-buttons{display:flex;gap:10px;margin-top:10px;}
        .salary-input-group{margin-bottom:20px;}
        .salary-input-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);}
        .salary-input{width:100%;padding:15px;border:1px solid var(--border);border-radius:12px;font-size:18px;font-weight:600;text-align:right;background-color:var(--light);}
        .salary-input:focus{outline:none;border-color:var(--primary);}
        .salary-result{background-color:rgba(88,86,214,0.1);border-radius:12px;padding:20px;margin-top:20px;text-align:center;border:2px solid var(--salary);}
        .salary-result h4{color:var(--salary);margin-bottom:10px;font-size:16px;}
        .salary-amount{font-size:28px;font-weight:700;color:var(--salary);margin-bottom:5px;}
        .salary-details{font-size:14px;color:var(--gray);margin-top:10px;text-align:left;}
        .salary-details div{margin-bottom:5px;display:flex;justify-content:space-between;}
        .notification{position:fixed;top:100px;right:20px;background-color:var(--success);color:white;padding:15px 20px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1001;transform:translateX(150%);transition:transform 0.3s ease;max-width:300px;}
        .notification.show{transform:translateX(0);}
        .notification.warning{background-color:var(--warning);}
        .notification.info{background-color:var(--primary);}
        .info-message{background-color:rgba(0,122,255,0.1);border-radius:12px;padding:15px;margin-bottom:20px;border-left:4px solid var(--primary);}
        .info-message h4{color:var(--primary);margin-bottom:5px;font-size:16px;display:flex;align-items:center;gap:8px;}
        
        .toggle-container{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:15px;background-color:var(--light);border-radius:12px;}
        .toggle-label{font-weight:600;color:var(--dark);display:flex;align-items:center;gap:10px;}
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;}
        .toggle-switch input{opacity:0;width:0;height:0;}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--toggle-off);transition:.4s;border-radius:34px;}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%;}
        input:checked + .toggle-slider{background-color:var(--toggle-on);}
        input:checked + .toggle-slider:before{transform:translateX(26px);}
        .toggle-status{font-size:14px;font-weight:600;color:var(--gray);}
        .toggle-status.active{color:var(--success);}
        
        .data-status{position:fixed;bottom:20px;right:20px;background-color:rgba(0,122,255,0.1);color:var(--primary);padding:8px 12px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:5px;z-index:999;}
        
        .backup-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;}
        
        @media (max-width:350px){.controls{grid-template-columns:1fr;}.btn-salary-control{grid-column:span 1;}.work-info{grid-template-columns:1fr;}.modal-content{padding:15px;}.edit-time{flex-direction:column;}.backup-buttons{grid-template-columns:1fr;}}
        .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:white;animation:spin 1s ease-in-out infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        @supports (-webkit-touch-callout:none){.btn,.month-select,.time-input,.salary-input,.overtime-input{-webkit-appearance:none;}.btn{-webkit-tap-highlight-color:transparent;}}
        
        /* iOS Optimizations */
        input, select, textarea {font-size:16px;}
        @media (max-width: 768px) {
            .header h1 {font-size:22px;}
            .time-display {font-size:28px;}
            .btn {padding:14px 10px;font-size:16px;}
        }
        @media (max-width: 480px) {
            .header h1 {font-size:20px;}
            .time-display {font-size:24px;}
            .btn {padding:12px 8px;font-size:15px;}
            .info-value {font-size:18px;}
        }
        
        /* Better touch targets for iPhone */
        .btn, .calendar-day, .calendar-nav-btn {min-height:44px;}
        .time-input, .overtime-input, .salary-input, .month-select {min-height:44px;}
        
        /* Hide delete section */
        .delete-section {display:none;}
        
        /* Add delete button in day detail */
        .delete-day-btn {
            background-color:var(--danger);
            color:white;
            border:none;
            border-radius:10px;
            padding:12px;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            margin-top:15px;
            width:100%;
        }
        
        /* Backup modal styles */
        .backup-info {
            background-color: rgba(0,122,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }
        .backup-info h4 {
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .backup-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .backup-stat {
            background-color: var(--light);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .backup-stat h4 {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        .backup-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-clock"></i> ‚è±Ô∏è Ch·∫•m C√¥ng TƒÉng Ca</h1>
            <p>‚è∞ Gi·ªù l√†m vi·ªác: 7:45 - 17:00 (T2-T7) | üéØ Ch·ªß nh·∫≠t: To√†n b·ªô l√† tƒÉng ca</p>
            <div class="day-indicator" id="dayIndicator">
                <i class="fas fa-calendar-day"></i> <span id="dayName">ƒêang t·∫£i...</span>
            </div>
        </div>
    </header>

    <div class="current-time">
        <h2><i class="fas fa-calendar-alt"></i> üìÖ H√¥m nay</h2>
        <div class="date-display" id="currentDate">ƒêang t·∫£i...</div>
        <div class="time-display" id="currentTime">00:00:00</div>
        <div id="workStatus" style="color: var(--primary); font-weight: 600; margin-top: 5px;">üü° Ch∆∞a b·∫Øt ƒë·∫ßu l√†m vi·ªác</div>
    </div>

    <div class="container">
        <div class="info-message">
            <h4><i class="fas fa-info-circle"></i> üìä Logic ch·∫•m c√¥ng</h4>
            <p><strong>üìÖ Th·ª© 2 - Th·ª© 7:</strong> T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu 7:45, n·∫øu ·∫•n "B·∫Øt ƒë·∫ßu" tr∆∞·ªõc 7:45 th√¨ tr∆∞·ªõc 7:45 l√† tƒÉng ca.</p>
            <p><strong>üéØ Ch·ªß nh·∫≠t:</strong> To√†n b·ªô th·ªùi gian t·ª´ B·∫Øt ƒë·∫ßu ƒë·∫øn Tan ca ƒë·ªÅu t√≠nh l√† tƒÉng ca.</p>
            <p><strong>‚è∞ M·∫∑c ƒë·ªãnh 17:00 tan ca:</strong> N·∫øu kh√¥ng ·∫•n "Tan Ca" s·∫Ω t·ª± ƒë·ªông tan ca l√∫c 17:00.</p>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-play-circle"></i> üéÆ ƒêi·ªÅu khi·ªÉn</h2>
            <div class="controls">
                <button class="btn btn-start" id="startWorkBtn">
                    <i class="fas fa-play"></i> üöÄ B·∫Øt ƒë·∫ßu
                </button>
                <button class="btn btn-end" id="endWorkBtn">
                    <i class="fas fa-stop"></i> üèÅ Tan ca
                </button>
            </div>
            
            <div id="autoStartInfo" class="auto-start-info" style="display: none;">
                <i class="fas fa-robot"></i> ü§ñ T·ª± ƒë·ªông k√≠ch ho·∫°t l√∫c 7:45 (T2-T7)
            </div>
            
            <div class="work-info">
                <div class="info-box">
                    <h3><i class="fas fa-sign-in-alt"></i> Gi·ªù b·∫Øt ƒë·∫ßu</h3>
                    <div class="info-value" id="startTime">--:--</div>
                </div>
                <div class="info-box">
                    <h3><i class="fas fa-sign-out-alt"></i> Gi·ªù k·∫øt th√∫c</h3>
                    <div class="info-value" id="endTime">--:--</div>
                </div>
                <div class="info-box">
                    <h3><i class="fas fa-clock"></i> T·ªïng th·ªùi gian</h3>
                    <div class="info-value" id="totalTime">0<span class="info-unit">gi·ªù</span></div>
                </div>
                <div class="info-box">
                    <h3><i class="fas fa-moon"></i> TƒÉng ca h√¥m nay</h3>
                    <div class="info-value" id="overtime">0<span class="info-unit">gi·ªù</span></div>
                </div>
            </div>
            
            <div class="expected-salary" id="expectedSalary" style="display: none;">
                <h4><i class="fas fa-coins"></i> üí∞ L∆∞∆°ng tƒÉng ca d·ª± ki·∫øn h√¥m nay</h4>
                <div class="expected-amount" id="expectedAmount">0 VNƒê</div>
            </div>
            
            <button class="btn btn-salary-control btn-full" id="salaryBtn">
                <i class="fas fa-calculator"></i> üßÆ T√≠nh L∆∞∆°ng TƒÉng Ca
            </button>
            
            <button class="btn btn-backup btn-full" id="backupBtn">
                <i class="fas fa-database"></i> üíæ Sao L∆∞u & Kh√¥i Ph·ª•c
            </button>
            
            <button class="btn btn-month btn-full" id="viewMonthBtn">
                <i class="fas fa-calendar-alt"></i> üìÖ Xem L·ªãch Th√°ng
            </button>
        </div>

        <div class="card">
            <h2><i class="fas fa-history"></i> üìú L·ªãch s·ª≠ l√†m vi·ªác</h2>
            <div class="work-history" id="workHistory">
                <div style="text-align: center; padding: 30px; color: var(--gray);">
                    <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</p>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>·ª®ng d·ª•ng Ch·∫•m C√¥ng TƒÉng Ca &copy; 2026</p>
        <p><i class="fas fa-database"></i> D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ vƒ©nh vi·ªÖn tr√™n thi·∫øt b·ªã</p>
        <p><i class="fas fa-mobile-alt"></i> T·ªëi ∆∞u cho iPhone - T·ª± ƒë·ªông l∆∞u m·ªói ph√∫t</p>
    </div>

    <div class="data-status" id="dataStatus">
        <i class="fas fa-database"></i> <span id="lastSaveTime">üü¢ ƒê√£ l∆∞u</span>
    </div>

    <div class="modal" id="monthCalendarModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calendar"></i> üìÖ L·ªãch Th√°ng
                <button class="close-btn" id="closeMonthModal">&times;</button>
            </h3>
            <div class="calendar" id="monthCalendar"></div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calendar-day"></i> üìã Chi Ti·∫øt Ng√†y
                <button class="close-btn" id="closeDayModal">&times;</button>
            </h3>
            <div class="day-detail" id="dayDetailContent"></div>
        </div>
    </div>

    <div class="modal" id="salaryModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calculator"></i> üßÆ T√≠nh L∆∞∆°ng TƒÉng Ca
                <button class="close-btn" id="closeSalaryModal">&times;</button>
            </h3>
            
            <div class="salary-input-group">
                <label for="basicSalary"><i class="fas fa-money-bill-wave"></i> L∆∞∆°ng cƒÉn b·∫£n (VNƒê)</label>
                <input type="number" id="basicSalary" class="salary-input" placeholder="Nh·∫≠p l∆∞∆°ng cƒÉn b·∫£n" min="0" step="100000">
            </div>
            
            <div class="salary-input-group">
                <label for="selectedMonth"><i class="fas fa-calendar"></i> Ch·ªçn th√°ng</label>
                <select id="selectedMonth" class="month-select">
                    <option value="">Ch·ªçn th√°ng...</option>
                </select>
            </div>
            
            <button class="btn btn-salary btn-full" id="calculateSalaryBtn">
                <i class="fas fa-calculator"></i> T√≠nh L∆∞∆°ng TƒÉng Ca
            </button>
            
            <div class="salary-result" id="salaryResult" style="display: none;">
                <h4>üí∞ L∆∞∆°ng tƒÉng ca d·ª± ki·∫øn th√°ng n√†y</h4>
                <div class="salary-amount" id="salaryAmount">0 VNƒê</div>
                <div class="salary-details" id="salaryDetails"></div>
            </div>
            
            <div style="margin-top:20px;padding:15px;background-color:rgba(0,122,255,0.1);border-radius:12px;">
                <h4 style="color:var(--primary);margin-bottom:10px;font-size:14px;">
                    <i class="fas fa-info-circle"></i> üìä C√¥ng th·ª©c t√≠nh
                </h4>
                <p style="font-size:13px;color:var(--gray);">
                    üí∞ Ti·ªÅn tƒÉng ca = S·ªë gi·ªù tƒÉng ca √ó (((L∆∞∆°ng cƒÉn b·∫£n √∑ 26) √∑ 8) √ó 2)
                </p>
            </div>
        </div>
    </div>

    <div class="modal" id="backupModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-database"></i> üíæ Sao L∆∞u & Kh√¥i Ph·ª•c
                <button class="close-btn" id="closeBackupModal">&times;</button>
            </h3>
            
            <div class="backup-info">
                <h4><i class="fas fa-info-circle"></i> Th√¥ng tin sao l∆∞u</h4>
                <p>Sao l∆∞u d·ªØ li·ªáu ch·∫•m c√¥ng c·ªßa b·∫°n ƒë·ªÉ ph√≤ng tr∆∞·ªùng h·ª£p m·∫•t d·ªØ li·ªáu ho·∫∑c ƒë·ªïi thi·∫øt b·ªã.</p>
            </div>
            
            <div class="backup-stats" id="backupStats">
                <div class="backup-stat">
                    <h4>T·ªïng b·∫£n ghi</h4>
                    <div class="backup-stat-value" id="totalRecords">0</div>
                </div>
                <div class="backup-stat">
                    <h4>Dung l∆∞·ª£ng</h4>
                    <div class="backup-stat-value" id="dataSize">0 KB</div>
                </div>
                <div class="backup-stat">
                    <h4>L·∫ßn sao l∆∞u cu·ªëi</h4>
                    <div class="backup-stat-value" id="lastBackupTime">Ch∆∞a c√≥</div>
                </div>
                <div class="backup-stat">
                    <h4>Phi√™n b·∫£n</h4>
                    <div class="backup-stat-value">2.0</div>
                </div>
            </div>
            
            <div class="backup-buttons">
                <button class="btn btn-backup" id="exportDataBtn">
                    <i class="fas fa-file-export"></i> Xu·∫•t D·ªØ Li·ªáu
                </button>
                <button class="btn btn-salary" id="importDataBtn">
                    <i class="fas fa-file-import"></i> Nh·∫≠p D·ªØ Li·ªáu
                </button>
                <button class="btn btn-success" id="backupToCloudBtn">
                    <i class="fas fa-cloud-upload-alt"></i> Sao L∆∞u ƒê√°m M√¢y
                </button>
                <button class="btn btn-secondary" id="restoreFromCloudBtn">
                    <i class="fas fa-cloud-download-alt"></i> Kh√¥i Ph·ª•c
                </button>
            </div>
            
            <div style="margin-top:20px;padding:15px;background-color:rgba(52,199,89,0.1);border-radius:12px;">
                <h4 style="color:var(--success);margin-bottom:10px;font-size:14px;">
                    <i class="fas fa-lightbulb"></i> üí° M·∫πo s·ª≠ d·ª•ng
                </h4>
                <p style="font-size:13px;color:var(--gray);">
                    1. Xu·∫•t d·ªØ li·ªáu ƒë·ªãnh k·ª≥ h√†ng tu·∫ßn<br>
                    2. L∆∞u file sao l∆∞u ·ªü nhi·ªÅu n∆°i an to√†n<br>
                    3. Tr∆∞·ªõc khi c·∫≠p nh·∫≠t ·ª©ng d·ª•ng, h√£y sao l∆∞u d·ªØ li·ªáu
                </p>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-exclamation-triangle"></i> ‚ö†Ô∏è X√°c nh·∫≠n x√≥a
                <button class="close-btn" id="closeDeleteModal">&times;</button>
            </h3>
            <p id="modalDeleteMessage" style="margin-bottom:20px;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ªØ li·ªáu ng√†y n√†y kh√¥ng?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelDeleteBtn">‚ùå H·ªßy</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">üóëÔ∏è X√≥a</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-file-import"></i> üìÇ Nh·∫≠p D·ªØ Li·ªáu
                <button class="close-btn" id="closeImportModal">&times;</button>
            </h3>
            
            <div class="backup-info" style="background-color: rgba(255,149,0,0.1); border-left-color: var(--warning);">
                <h4 style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> C·∫£nh b√°o quan tr·ªçng</h4>
                <p>Vi·ªác nh·∫≠p d·ªØ li·ªáu s·∫Ω <strong>GHI ƒê√à</strong> to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ sao l∆∞u d·ªØ li·ªáu hi·ªán t·∫°i tr∆∞·ªõc khi ti·∫øp t·ª•c.</p>
            </div>
            
            <div style="margin: 20px 0;">
                <label for="backupFile" style="display:block;margin-bottom:10px;font-weight:600;">
                    <i class="fas fa-file"></i> Ch·ªçn file sao l∆∞u (.json)
                </label>
                <input type="file" id="backupFile" accept=".json,application/json" style="width:100%;padding:12px;border:2px dashed var(--border);border-radius:12px;">
                <div id="fileInfo" style="margin-top:10px;padding:10px;background-color:var(--light);border-radius:8px;display:none;">
                    <div><strong>T√™n file:</strong> <span id="fileName"></span></div>
                    <div><strong>K√≠ch th∆∞·ªõc:</strong> <span id="fileSize"></span></div>
                    <div><strong>S·ªë b·∫£n ghi:</strong> <span id="fileRecords"></span></div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelImportBtn">‚ùå H·ªßy</button>
                <button class="btn btn-warning" id="confirmImportBtn" disabled>üì• Nh·∫≠p D·ªØ Li·ªáu</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationMessage">‚úÖ Thao t√°c th√†nh c√¥ng!</div>
    </div>

    <script>
        let workStartTime = null;
        let workEndTime = null;
        let isWorking = false;
        let timerInterval = null;
        let autoSaveInterval = null;
        let workData = [];
        let today = new Date();
        let dayOfWeek = today.getDay();
        let isSunday = (dayOfWeek === 0);
        let isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 6);
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        let selectedDate = null;
        let selectedDayData = null;
        let basicSalary = 0;
        let autoStartTriggered = false;
        let earlyOvertime = 0;
        let lateOvertime = 0;
        let dateToDelete = null;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let lastBackupTime = null;

        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            updateDayName();
            loadWorkData();
            loadBackupInfo();
            initSalaryMonthSelect();
            loadBasicSalary();
            
            document.getElementById('startWorkBtn').addEventListener('click', startWork);
            document.getElementById('endWorkBtn').addEventListener('click', endWork);
            document.getElementById('viewMonthBtn').addEventListener('click', function() { showMonthCalendar(); });
            document.getElementById('salaryBtn').addEventListener('click', function() { showSalaryModal(); });
            document.getElementById('backupBtn').addEventListener('click', function() { showBackupModal(); });
            document.getElementById('closeMonthModal').addEventListener('click', hideMonthModal);
            document.getElementById('closeDayModal').addEventListener('click', hideDayModal);
            document.getElementById('closeSalaryModal').addEventListener('click', hideSalaryModal);
            document.getElementById('closeBackupModal').addEventListener('click', hideBackupModal);
            document.getElementById('closeDeleteModal').addEventListener('click', hideDeleteModal);
            document.getElementById('closeImportModal').addEventListener('click', hideImportModal);
            document.getElementById('calculateSalaryBtn').addEventListener('click', calculateSalary);
            document.getElementById('basicSalary').addEventListener('change', saveBasicSalary);
            document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteDay);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', showImportModal);
            document.getElementById('backupToCloudBtn').addEventListener('click', backupToCloud);
            document.getElementById('restoreFromCloudBtn').addEventListener('click', restoreFromCloud);
            document.getElementById('cancelImportBtn').addEventListener('click', hideImportModal);
            document.getElementById('confirmImportBtn').addEventListener('click', importData);
            document.getElementById('backupFile').addEventListener('change', handleFileSelect);
            
            checkTodayWorkStatus();
            checkAutoStart();
            updateButtonStates();
            
            startAutoSave();
            setupIOSDataProtection();
            
            showNotification('‚úÖ ·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng! D·ªØ li·ªáu ƒë∆∞·ª£c b·∫£o v·ªá an to√†n.', 'info');
        }

        function setupIOSDataProtection() {
            if (isIOS) {
                // TƒÉng t·∫ßn su·∫•t l∆∞u d·ªØ li·ªáu cho iOS
                if (autoSaveInterval) clearInterval(autoSaveInterval);
                autoSaveInterval = setInterval(() => {
                    saveDataToStorage();
                    updateDataStatus();
                }, 30000); // L∆∞u m·ªói 30 gi√¢y cho iOS
                
                // L∆∞u d·ªØ li·ªáu khi app chuy·ªÉn sang background
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        saveDataToStorage();
                        console.log('iOS: L∆∞u d·ªØ li·ªáu khi app chuy·ªÉn background');
                    }
                });
                
                // L∆∞u d·ªØ li·ªáu khi tho√°t app
                window.addEventListener('pagehide', function() {
                    saveDataToStorage();
                    console.log('iOS: L∆∞u d·ªØ li·ªáu khi pagehide');
                });
                
                // L∆∞u d·ªØ li·ªáu khi t·∫£i l·∫°i trang
                window.addEventListener('beforeunload', function(e) {
                    saveDataToStorage();
                    console.log('iOS: L∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi unload');
                    // Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu ƒëang l√†m vi·ªác
                    if (isWorking) {
                        e.preventDefault();
                        e.returnValue = 'B·∫°n ƒëang trong gi·ªù l√†m vi·ªác. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông.';
                    }
                });
                
                console.log('iOS Data Protection ƒë√£ k√≠ch ho·∫°t');
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            today = now;
            dayOfWeek = today.getDay();
            isSunday = (dayOfWeek === 0);
            isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 6);
            
            const dateStr = now.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('vi-VN');
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
            
            checkAutoStart();
            checkAutoEnd();
        }

        function checkAutoStart() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDay = now.getDay();
            
            const isWeekdayAuto = (currentDay >= 1 && currentDay <= 6);
            
            if (isWeekdayAuto && currentHour >= 7 && currentMinute >= 45 && !autoStartTriggered) {
                if (!isWorking) {
                    autoStartWork();
                }
            }
        }

        function checkAutoEnd() {
            if (isWorking && isWeekday) {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                if (currentHour >= 17 && currentMinute > 0) {
                    autoEndWork();
                }
            }
        }

        function autoStartWork() {
            autoStartTriggered = true;
            
            const startTimeToday = new Date(today);
            startTimeToday.setHours(7, 45, 0, 0);
            
            const todayStr = formatDate(today);
            const todayRecord = workData.find(record => record.date === todayStr);
            
            if (todayRecord) {
                return;
            }
            
            workStartTime = startTimeToday;
            isWorking = true;
            
            document.getElementById('startTime').textContent = '07:45';
            document.getElementById('workStatus').textContent = 'üü¢ ƒêang l√†m vi·ªác (t·ª± ƒë·ªông 7:45)';
            document.getElementById('workStatus').style.color = 'var(--success)';
            
            const startBtn = document.getElementById('startWorkBtn');
            startBtn.classList.add('auto-activated');
            
            const autoStartInfo = document.getElementById('autoStartInfo');
            autoStartInfo.style.display = 'flex';
            
            updateButtonStates();
            startTimer();
            createAutoWorkRecord();
            
            showNotification('ü§ñ T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu l√†m vi·ªác t·ª´ 7:45', 'info');
        }

        function autoEndWork() {
            if (!isWorking) return;
            
            const endTimeToday = new Date(today);
            endTimeToday.setHours(17, 0, 0, 0);
            
            workEndTime = endTimeToday;
            isWorking = false;
            
            stopTimer();
            
            const workDuration = calculateWorkDuration(workStartTime, workEndTime);
            
            let overtime = 0;
            
            if (isWeekday) {
                const standardStartTime = new Date(workStartTime);
                standardStartTime.setHours(7, 45, 0, 0);
                
                if (workStartTime < standardStartTime) {
                    earlyOvertime = calculateWorkDuration(workStartTime, standardStartTime);
                } else {
                    earlyOvertime = 0;
                }
                
                overtime = earlyOvertime;
                
            } else if (isSunday) {
                overtime = workDuration;
            }
            
            document.getElementById('endTime').textContent = '17:00';
            document.getElementById('totalTime').innerHTML = `${workDuration.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
            document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
            document.getElementById('workStatus').textContent = 'üü° ƒê√£ k·∫øt th√∫c l√†m vi·ªác (t·ª± ƒë·ªông 17:00)';
            document.getElementById('workStatus').style.color = 'var(--warning)';
            
            updateButtonStates();
            saveWorkData(workStartTime, workEndTime, workDuration, overtime, true);
            updateWorkHistory();
            updateExpectedSalary();
            
            showNotification(`‚è∞ T·ª± ƒë·ªông tan ca 17:00. TƒÉng ca: ${overtime.toFixed(2)} gi·ªù`, 'info');
        }

        function createAutoWorkRecord() {
            const todayStr = formatDate(today);
            const startTimeToday = new Date(today);
            startTimeToday.setHours(7, 45, 0, 0);
            
            const workRecord = {
                id: Date.now(),
                date: todayStr,
                dateISO: formatDateISO(startTimeToday),
                startTime: '07:45',
                endTime: null,
                totalHours: '0.00',
                overtime: '0.00',
                manualOvertime: '0.00',
                lunchOvertime: 0,
                earlyOvertime: 0,
                lateOvertime: 0,
                isAutoEnded: false,
                timestamp: startTimeToday.getTime(),
                isWeekday: true,
                isAutoStarted: true
            };
            
            workData.unshift(workRecord);
            
            if (workData.length > 1000) {
                workData = workData.slice(0, 1000);
            }
            
            saveDataToStorage();
            updateWorkHistory();
        }

        function updateDayName() {
            const dayNames = ['Ch·ªß nh·∫≠t', 'Th·ª© hai', 'Th·ª© ba', 'Th·ª© t∆∞', 'Th·ª© nƒÉm', 'Th·ª© s√°u', 'Th·ª© b·∫£y'];
            const dayName = dayNames[dayOfWeek];
            
            document.getElementById('dayName').textContent = dayName;
            
            const dayIndicator = document.getElementById('dayIndicator');
            if (isSunday) {
                dayIndicator.classList.add('sunday');
            } else {
                dayIndicator.classList.remove('sunday');
            }
        }

        function loadBasicSalary() {
            try {
                const savedSalary = localStorage.getItem('chamcong_basic_salary');
                if (savedSalary) {
                    basicSalary = parseInt(savedSalary);
                    document.getElementById('basicSalary').value = basicSalary;
                }
            } catch (e) {
                console.log('Kh√¥ng c√≥ l∆∞∆°ng c∆° b·∫£n ƒë√£ l∆∞u');
            }
        }

        function saveBasicSalary() {
            try {
                const salaryInput = document.getElementById('basicSalary');
                const salary = parseInt(salaryInput.value) || 0;
                basicSalary = salary;
                localStorage.setItem('chamcong_basic_salary', salary.toString());
                showNotification('üíæ ƒê√£ l∆∞u l∆∞∆°ng cƒÉn b·∫£n', 'success');
                updateExpectedSalary();
            } catch (e) {
                showNotification('‚ùå L·ªói khi l∆∞u l∆∞∆°ng cƒÉn b·∫£n', 'danger');
            }
        }

        function loadBackupInfo() {
            try {
                const backupInfo = localStorage.getItem('chamcong_backup_info');
                if (backupInfo) {
                    const info = JSON.parse(backupInfo);
                    lastBackupTime = info.lastBackupTime;
                    updateBackupStats();
                }
            } catch (e) {
                console.log('Kh√¥ng c√≥ th√¥ng tin sao l∆∞u');
            }
        }

        function saveBackupInfo() {
            try {
                const backupInfo = {
                    lastBackupTime: new Date().toISOString(),
                    totalRecords: workData.length,
                    appVersion: '2.0'
                };
                localStorage.setItem('chamcong_backup_info', JSON.stringify(backupInfo));
                lastBackupTime = backupInfo.lastBackupTime;
                updateBackupStats();
            } catch (e) {
                console.log('L·ªói khi l∆∞u th√¥ng tin sao l∆∞u');
            }
        }

        function updateBackupStats() {
            document.getElementById('totalRecords').textContent = workData.length;
            
            const dataStr = JSON.stringify(workData);
            const dataSize = new Blob([dataStr]).size;
            const dataSizeKB = (dataSize / 1024).toFixed(2);
            document.getElementById('dataSize').textContent = `${dataSizeKB} KB`;
            
            if (lastBackupTime) {
                const lastBackupDate = new Date(lastBackupTime);
                const formattedTime = lastBackupDate.toLocaleDateString('vi-VN') + ' ' + 
                                     lastBackupDate.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                document.getElementById('lastBackupTime').textContent = formattedTime;
            } else {
                document.getElementById('lastBackupTime').textContent = 'Ch∆∞a c√≥';
            }
        }

        function updateExpectedSalary() {
            const expectedSalaryDiv = document.getElementById('expectedSalary');
            const expectedAmount = document.getElementById('expectedAmount');
            
            if (basicSalary > 0) {
                const todayStr = formatDate(today);
                const todayRecord = workData.find(record => record.date === todayStr);
                
                if (todayRecord && todayRecord.endTime) {
                    const overtime = parseFloat(todayRecord.overtime);
                    
                    if (overtime > 0) {
                        const dailySalary = basicSalary / 26;
                        const hourlySalary = dailySalary / 8;
                        const overtimeRate = 2;
                        const salary = overtime * (hourlySalary * overtimeRate);
                        
                        expectedAmount.textContent = formatCurrency(salary);
                        expectedSalaryDiv.style.display = 'block';
                    } else {
                        expectedSalaryDiv.style.display = 'none';
                    }
                } else {
                    expectedSalaryDiv.style.display = 'none';
                }
            } else {
                expectedSalaryDiv.style.display = 'none';
            }
        }

        function initSalaryMonthSelect() {
            const salaryMonthSelect = document.getElementById('selectedMonth');
            const months = new Set();
            
            const currentMonthYear = `${currentMonth + 1}/${currentYear}`;
            months.add(currentMonthYear);
            
            workData.forEach(record => {
                const date = new Date(record.timestamp);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                months.add(monthYear);
            });
            
            salaryMonthSelect.innerHTML = '<option value="">Ch·ªçn th√°ng...</option>';
            
            const monthsArray = Array.from(months).sort((a, b) => {
                const [aMonth, aYear] = a.split('/').map(Number);
                const [bMonth, bYear] = b.split('/').map(Number);
                
                if (aYear !== bYear) return bYear - aYear;
                return bMonth - aMonth;
            });
            
            monthsArray.forEach(monthYear => {
                const [month, year] = monthYear.split('/');
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = `Th√°ng ${month}/${year}`;
                if (monthYear === currentMonthYear) {
                    option.selected = true;
                }
                salaryMonthSelect.appendChild(option);
            });
        }

        function checkTodayWorkStatus() {
            const todayStr = formatDate(today);
            const todayRecord = workData.find(record => record.date === todayStr);
            
            if (todayRecord) {
                workStartTime = parseTimeString(todayRecord.startTime, today);
                workEndTime = todayRecord.endTime ? parseTimeString(todayRecord.endTime, today) : null;
                isWorking = !todayRecord.endTime;
                earlyOvertime = todayRecord.earlyOvertime || 0;
                lateOvertime = todayRecord.lateOvertime || 0;
                
                if (todayRecord.isAutoStarted) {
                    autoStartTriggered = true;
                    const startBtn = document.getElementById('startWorkBtn');
                    startBtn.classList.add('auto-activated');
                    
                    const autoStartInfo = document.getElementById('autoStartInfo');
                    autoStartInfo.style.display = 'flex';
                }
                
                document.getElementById('startTime').textContent = formatTime(workStartTime);
                
                if (workEndTime) {
                    document.getElementById('endTime').textContent = formatTime(workEndTime);
                    document.getElementById('workStatus').textContent = todayRecord.isAutoEnded ? 
                        'üü° ƒê√£ k·∫øt th√∫c l√†m vi·ªác (t·ª± ƒë·ªông 17:00)' : 'üü° ƒê√£ k·∫øt th√∫c l√†m vi·ªác';
                    document.getElementById('workStatus').style.color = 'var(--warning)';
                    
                    const totalHours = parseFloat(todayRecord.totalHours);
                    const overtime = parseFloat(todayRecord.overtime);
                    
                    document.getElementById('totalTime').innerHTML = `${totalHours.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
                    document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
                    
                    updateExpectedSalary();
                } else {
                    document.getElementById('endTime').textContent = '--:--';
                    document.getElementById('workStatus').textContent = 'üü¢ ƒêang l√†m vi·ªác';
                    document.getElementById('workStatus').style.color = 'var(--success)';
                    startTimer();
                }
            }
            
            updateButtonStates();
        }

        function updateButtonStates() {
            const startBtn = document.getElementById('startWorkBtn');
            const endBtn = document.getElementById('endWorkBtn');
            
            if (isWeekday) {
                startBtn.style.display = 'flex';
                endBtn.style.display = 'flex';
                
                if (isWorking) {
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    endBtn.disabled = true;
                }
            } else if (isSunday) {
                startBtn.style.display = 'flex';
                endBtn.style.display = 'flex';
                
                if (isWorking) {
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    endBtn.disabled = true;
                }
            }
        }

        function startWork() {
            if (isWorking) {
                showNotification('‚ö†Ô∏è B·∫°n ƒë√£ b·∫Øt ƒë·∫ßu l√†m vi·ªác tr∆∞·ªõc ƒë√≥!', 'warning');
                return;
            }
            
            workStartTime = new Date();
            isWorking = true;
            
            document.getElementById('startTime').textContent = formatTime(workStartTime);
            document.getElementById('workStatus').textContent = 'üü¢ ƒêang l√†m vi·ªác';
            document.getElementById('workStatus').style.color = 'var(--success)';
            
            const autoStartInfo = document.getElementById('autoStartInfo');
            autoStartInfo.style.display = 'none';
            
            const startBtn = document.getElementById('startWorkBtn');
            startBtn.classList.remove('auto-activated');
            
            updateButtonStates();
            startTimer();
            
            const todayStr = formatDate(today);
            const autoRecordIndex = workData.findIndex(record => record.date === todayStr && record.isAutoStarted);
            if (autoRecordIndex >= 0) {
                workData.splice(autoRecordIndex, 1);
            }
            
            showNotification('üöÄ ƒê√£ b·∫Øt ƒë·∫ßu l√†m vi·ªác', 'success');
        }

        function endWork() {
            if (!isWorking) {
                showNotification('‚ö†Ô∏è B·∫°n ch∆∞a b·∫Øt ƒë·∫ßu l√†m vi·ªác!', 'warning');
                return;
            }
            
            workEndTime = new Date();
            isWorking = false;
            
            stopTimer();
            
            const workDuration = calculateWorkDuration(workStartTime, workEndTime);
            let overtime = 0;
            
            if (isWeekday) {
                const standardStartTime = new Date(workStartTime);
                standardStartTime.setHours(7, 45, 0, 0);
                
                if (workStartTime < standardStartTime) {
                    earlyOvertime = calculateWorkDuration(workStartTime, standardStartTime);
                } else {
                    earlyOvertime = 0;
                }
                
                const standardEndTime = new Date(workStartTime);
                standardEndTime.setHours(17, 0, 0, 0);
                
                if (workEndTime > standardEndTime) {
                    lateOvertime = calculateWorkDuration(standardEndTime, workEndTime);
                } else {
                    lateOvertime = 0;
                }
                
                overtime = earlyOvertime + lateOvertime;
                
            } else if (isSunday) {
                overtime = workDuration;
            }
            
            document.getElementById('endTime').textContent = formatTime(workEndTime);
            document.getElementById('totalTime').innerHTML = `${workDuration.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
            document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
            document.getElementById('workStatus').textContent = 'üü° ƒê√£ k·∫øt th√∫c l√†m vi·ªác';
            document.getElementById('workStatus').style.color = 'var(--warning)';
            
            updateButtonStates();
            saveWorkData(workStartTime, workEndTime, workDuration, overtime, false);
            updateWorkHistory();
            updateExpectedSalary();
            
            showNotification(`üèÅ ƒê√£ tan ca. TƒÉng ca: ${overtime.toFixed(2)} gi·ªù`, 'success');
        }

        function calculateWorkDuration(startTime, endTime) {
            const diffMs = endTime - startTime;
            const diffMinutes = diffMs / (1000 * 60);
            const diffHours = diffMinutes / 60;
            return diffHours;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN');
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseTimeString(timeStr, baseDate) {
            if (!timeStr) return null;
            
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date(baseDate);
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function parseDateString(dateStr) {
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (workStartTime && isWorking) {
                    const now = new Date();
                    const duration = calculateWorkDuration(workStartTime, now);
                    
                    let overtime = 0;
                    
                    if (isWeekday) {
                        const standardStartTime = new Date(workStartTime);
                        standardStartTime.setHours(7, 45, 0, 0);
                        
                        if (workStartTime < standardStartTime) {
                            earlyOvertime = calculateWorkDuration(workStartTime, standardStartTime);
                        }
                        
                        const standardEndTime = new Date(workStartTime);
                        standardEndTime.setHours(17, 0, 0, 0);
                        
                        if (now > standardEndTime) {
                            lateOvertime = calculateWorkDuration(standardEndTime, now);
                        }
                        
                        overtime = earlyOvertime + lateOvertime;
                    } else if (isSunday) {
                        overtime = duration;
                    }
                    
                    document.getElementById('totalTime').innerHTML = `${duration.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
                    document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">gi·ªù</span>`;
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function saveWorkData(startTime, endTime, totalHours, overtime, isAutoEnded = false) {
            const todayStr = formatDate(today);
            
            const existingIndex = workData.findIndex(record => record.date === todayStr);
            
            const workRecord = {
                id: Date.now(),
                date: todayStr,
                dateISO: formatDateISO(startTime),
                startTime: formatTime(startTime),
                endTime: endTime ? formatTime(endTime) : null,
                totalHours: totalHours.toFixed(2),
                overtime: overtime.toFixed(2),
                manualOvertime: '0.00',
                lunchOvertime: 0,
                earlyOvertime: earlyOvertime.toFixed(2),
                lateOvertime: lateOvertime.toFixed(2),
                isAutoEnded: isAutoEnded,
                timestamp: startTime.getTime(),
                isWeekday: isWeekday,
                isAutoStarted: false
            };
            
            if (existingIndex >= 0) {
                if (workData[existingIndex].lunchOvertime) {
                    workRecord.lunchOvertime = workData[existingIndex].lunchOvertime;
                    workRecord.overtime = (parseFloat(workRecord.overtime) + workRecord.lunchOvertime).toFixed(2);
                }
                if (workData[existingIndex].manualOvertime) {
                    workRecord.manualOvertime = workData[existingIndex].manualOvertime;
                    workRecord.overtime = (parseFloat(workRecord.overtime) + parseFloat(workRecord.manualOvertime)).toFixed(2);
                }
                
                workData[existingIndex] = workRecord;
            } else {
                workData.unshift(workRecord);
            }
            
            if (workData.length > 1000) {
                workData = workData.slice(0, 1000);
            }
            
            saveDataToStorage();
            initSalaryMonthSelect();
        }

        function startAutoSave() {
            updateDataStatus();
            
            autoSaveInterval = setInterval(() => {
                saveDataToStorage();
                updateDataStatus();
            }, isIOS ? 30000 : 60000);
            
            window.addEventListener('beforeunload', function() {
                saveDataToStorage();
            });
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveDataToStorage();
                }
            });
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('chamcong_work_data', JSON.stringify(workData));
                
                if (isWorking && workStartTime) {
                    const currentWorkState = {
                        isWorking: isWorking,
                        workStartTime: workStartTime.getTime(),
                        lastUpdate: Date.now(),
                        isIOS: isIOS
                    };
                    localStorage.setItem('chamcong_current_state', JSON.stringify(currentWorkState));
                } else {
                    localStorage.removeItem('chamcong_current_state');
                }
                
                const now = new Date();
                const lastSaveTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                localStorage.setItem('chamcong_last_save', lastSaveTime);
                
                updateDataStatus();
                return true;
            } catch (error) {
                console.error('L·ªói khi l∆∞u d·ªØ li·ªáu:', error);
                showNotification('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu', 'danger');
                return false;
            }
        }

        function updateDataStatus() {
            try {
                const lastSaveTime = localStorage.getItem('chamcong_last_save') || 'V·ª´a xong';
                document.getElementById('lastSaveTime').textContent = `üíæ L∆∞u: ${lastSaveTime}`;
            } catch (e) {
                document.getElementById('lastSaveTime').textContent = '‚ùå L·ªói';
            }
        }

        function loadWorkData() {
            try {
                const savedData = localStorage.getItem('chamcong_work_data');
                
                if (savedData) {
                    workData = JSON.parse(savedData);
                    
                    const currentWorkState = localStorage.getItem('chamcong_current_state');
                    if (currentWorkState) {
                        const state = JSON.parse(currentWorkState);
                        const lastUpdate = new Date(state.lastUpdate);
                        const now = new Date();
                        const diffMinutes = (now - lastUpdate) / (1000 * 60);
                        
                        if (diffMinutes < 1440 && state.isWorking) { // 24 gi·ªù
                            workStartTime = new Date(state.workStartTime);
                            
                            const todayStr = formatDate(today);
                            const todayRecord = workData.find(record => record.date === todayStr);
                            
                            if (!todayRecord) {
                                const newRecord = {
                                    id: Date.now(),
                                    date: todayStr,
                                    dateISO: formatDateISO(workStartTime),
                                    startTime: formatTime(workStartTime),
                                    endTime: null,
                                    totalHours: '0.00',
                                    overtime: '0.00',
                                    manualOvertime: '0.00',
                                    lunchOvertime: 0,
                                    earlyOvertime: 0,
                                    lateOvertime: 0,
                                    isAutoEnded: false,
                                    timestamp: workStartTime.getTime(),
                                    isWeekday: isWeekday,
                                    isAutoStarted: false
                                };
                                workData.unshift(newRecord);
                                isWorking = true;
                            } else if (!todayRecord.endTime) {
                                isWorking = true;
                            }
                        }
                    }
                    
                    updateWorkHistory();
                    initSalaryMonthSelect();
                    updateDataStatus();
                    updateBackupStats();
                } else {
                    workData = [];
                }
            } catch (error) {
                workData = [];
                showNotification('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu c≈©', 'danger');
            }
        }

        function updateWorkHistory() {
            const historyContainer = document.getElementById('workHistory');
            
            if (workData.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            
            workData.forEach(record => {
                const isTodayRecord = record.date === formatDate(today);
                const todayClass = isTodayRecord ? 'style="color: var(--primary); font-weight: 700;"' : '';
                const totalOvertime = parseFloat(record.overtime);
                const lunchOvertime = record.lunchOvertime || 0;
                const autoStarted = record.isAutoStarted || false;
                const isAutoEnded = record.isAutoEnded || false;
                const isSundayRecord = !record.isWeekday;
                
                const dayIcon = isSundayRecord ? 'üéØ' : 'üìÖ';
                const autoStartIcon = autoStarted ? 'ü§ñ' : '';
                const autoEndIcon = isAutoEnded ? '‚è∞' : '';
                const lunchIcon = lunchOvertime > 0 ? 'üç¥' : '';
                
                historyHTML += `
                    <div class="history-item">
                        <div>
                            <div class="history-date" ${todayClass}>
                                ${dayIcon} ${record.date} ${isSundayRecord ? '(CN)' : '(T2-T7)'} 
                                ${autoStartIcon} ${autoEndIcon}
                            </div>
                            <div class="history-time">${record.startTime} - ${record.endTime || '--:--'}</div>
                        </div>
                        <div class="history-overtime">
                            ${record.endTime ? `üí∞ +${totalOvertime.toFixed(2)} gi·ªù` : 'üü¢ ƒêang l√†m'} 
                            ${lunchIcon}
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }

        function showSalaryModal() {
            document.getElementById('salaryModal').style.display = 'flex';
        }

        function showBackupModal() {
            updateBackupStats();
            document.getElementById('backupModal').style.display = 'flex';
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'flex';
            hideBackupModal();
        }

        function hideMonthModal() {
            document.getElementById('monthCalendarModal').style.display = 'none';
        }

        function hideDayModal() {
            document.getElementById('dayDetailModal').style.display = 'none';
        }

        function hideSalaryModal() {
            document.getElementById('salaryModal').style.display = 'none';
        }

        function hideBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function hideImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('backupFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = true;
        }

        function hideDeleteModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
            dateToDelete = null;
        }

        function showMonthCalendar() {
            renderCalendar(currentMonth, currentYear);
            document.getElementById('monthCalendarModal').style.display = 'flex';
        }

        function renderCalendar(month, year) {
            const calendarElement = document.getElementById('monthCalendar');
            
            const monthNames = [
                'Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
                'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'
            ];
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();
            
            let calendarHTML = `
                <div class="calendar-header">
                    <div class="calendar-month-year">${monthNames[month]} ${year}</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                        <button class="calendar-nav-btn" id="todayMonthBtn">H√¥m nay</button>
                        <button class="calendar-nav-btn" id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-weekdays">
                    <div>CN</div><div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div>
                </div>
                <div class="calendar-days">
            `;
            
            for (let i = 0; i < firstDayIndex; i++) {
                calendarHTML += `<div class="calendar-day empty"></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                const isToday = currentDate.toDateString() === today.toDateString();
                const isSunday = currentDate.getDay() === 0;
                
                const dayData = workData.find(record => record.date === dateStr);
                const hasData = !!dayData;
                const hasLunchOvertime = hasData && dayData.lunchOvertime > 0;
                const overtime = hasData ? parseFloat(dayData.overtime) : 0;
                const isAutoEnded = hasData ? (dayData.isAutoEnded || false) : false;
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (hasData) dayClass += ' has-data';
                if (isSunday) dayClass += ' sunday';
                
                let overtimeIcon = '';
                if (isAutoEnded) {
                    overtimeIcon = '<i class="fas fa-clock" style="color: var(--warning); font-size: 10px; position: absolute; top: 2px; left: 2px;"></i>';
                }
                
                calendarHTML += `
                    <div class="${dayClass}" data-date="${dateStr}" data-has-data="${hasData}">
                        ${day}
                        ${overtimeIcon}
                        ${hasLunchOvertime ? '<div class="day-lunch"></div>' : ''}
                        ${hasData && overtime > 0 ? `<div class="day-overtime">+${overtime.toFixed(1)}h</div>` : ''}
                    </div>
                `;
            }
            
            calendarHTML += `</div>`;
            calendarElement.innerHTML = calendarHTML;
            
            document.getElementById('prevMonthBtn').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            document.getElementById('nextMonthBtn').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            document.getElementById('todayMonthBtn').addEventListener('click', function() {
                const now = new Date();
                currentMonth = now.getMonth();
                currentYear = now.getFullYear();
                renderCalendar(currentMonth, currentYear);
            });
            
            setTimeout(() => {
                const dayElements = document.querySelectorAll('.calendar-day:not(.empty)');
                dayElements.forEach(dayElement => {
                    dayElement.addEventListener('click', function() {
                        const dateStr = this.getAttribute('data-date');
                        const hasData = this.getAttribute('data-has-data') === 'true';
                        showDayDetail(dateStr, hasData);
                    });
                });
            }, 100);
        }

        function showDayDetail(dateStr, hasData = true) {
            selectedDate = parseDateString(dateStr);
            selectedDayData = workData.find(record => record.date === dateStr);
            
            const dayDetailElement = document.getElementById('dayDetailContent');
            
            if (selectedDayData && hasData) {
                const totalOvertime = parseFloat(selectedDayData.overtime);
                const lunchOvertime = selectedDayData.lunchOvertime || 0;
                const manualOvertime = parseFloat(selectedDayData.manualOvertime || 0);
                const earlyOvertime = parseFloat(selectedDayData.earlyOvertime || 0);
                const lateOvertime = parseFloat(selectedDayData.lateOvertime || 0);
                const isWeekdayDetail = selectedDayData.isWeekday;
                const isAutoEnded = selectedDayData.isAutoEnded || false;
                const autoStarted = selectedDayData.isAutoStarted || false;
                
                let logicInfo = '';
                if (isWeekdayDetail) {
                    logicInfo = `
                        <div style="margin-bottom:15px;padding:12px;background-color:rgba(0,122,255,0.1);border-radius:10px;">
                            <div style="font-size:13px;color:var(--primary);">
                                <strong><i class="fas fa-calculator"></i> Logic t√≠nh tƒÉng ca:</strong><br>
                                ‚Ä¢ S·ªõm tr∆∞·ªõc 7:45: ${earlyOvertime.toFixed(2)} gi·ªù<br>
                                ‚Ä¢ Mu·ªôn sau 17:00: ${lateOvertime.toFixed(2)} gi·ªù<br>
                                ‚Ä¢ Tr∆∞a: ${lunchOvertime.toFixed(2)} gi·ªù
                                ${isAutoEnded ? '<br>‚Ä¢ ‚è∞ T·ª± ƒë·ªông tan ca 17:00' : ''}
                                ${autoStarted ? '<br>‚Ä¢ ü§ñ T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu 7:45' : ''}
                            </div>
                        </div>
                    `;
                } else {
                    logicInfo = `
                        <div style="margin-bottom:15px;padding:12px;background-color:rgba(255,45,85,0.1);border-radius:10px;">
                            <div style="font-size:13px;color:var(--sunday);">
                                <strong><i class="fas fa-calculator"></i> Ch·ªß nh·∫≠t:</strong> To√†n b·ªô th·ªùi gian ƒë·ªÅu t√≠nh l√† tƒÉng ca
                            </div>
                        </div>
                    `;
                }
                
                dayDetailElement.innerHTML = `
                    <div class="day-detail-info">
                        <div class="detail-box">
                            <h4>Ng√†y</h4>
                            <div class="detail-value">${dateStr}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Lo·∫°i ng√†y</h4>
                            <div class="detail-value">${isWeekdayDetail ? 'T2-T7' : 'Ch·ªß nh·∫≠t'}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Gi·ªù v√†o</h4>
                            <div class="detail-value">${selectedDayData.startTime}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Gi·ªù tan</h4>
                            <div class="detail-value">${selectedDayData.endTime || '--:--'}</div>
                        </div>
                        <div class="detail-box">
                            <h4>T·ªïng gi·ªù</h4>
                            <div class="detail-value">${selectedDayData.totalHours} gi·ªù</div>
                        </div>
                        <div class="detail-box">
                            <h4>TƒÉng ca</h4>
                            <div class="detail-value">${totalOvertime.toFixed(2)} gi·ªù</div>
                        </div>
                    </div>
                    
                    ${logicInfo}
                    
                    <div class="edit-time">
                        <input type="time" id="editStartTime" class="time-input" value="${selectedDayData.startTime}">
                        <span>ƒë·∫øn</span>
                        <input type="time" id="editEndTime" class="time-input" value="${selectedDayData.endTime || ''}">
                    </div>
                    
                    <div class="edit-overtime">
                        <label for="editManualOvertime">S·ª≠a gi·ªù tƒÉng ca (gi·ªù)</label>
                        <input type="number" id="editManualOvertime" class="overtime-input" value="${manualOvertime.toFixed(2)}" step="0.25" min="0">
                    </div>
                    
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <i class="fas fa-utensils" style="color: var(--warning);"></i>
                            <span>TƒÉng ca tr∆∞a (1 gi·ªù)</span>
                        </div>
                        <div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="lunchOvertimeToggle" ${lunchOvertime > 0 ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-status ${lunchOvertime > 0 ? 'active' : ''}" id="toggleStatus">
                                ${lunchOvertime > 0 ? 'B·∫¨T' : 'T·∫ÆT'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="edit-buttons">
                        <button class="btn btn-secondary btn-small" id="updateTimeBtn">
                            <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
                        </button>
                        <button class="delete-day-btn" id="deleteDayBtn">
                            <i class="fas fa-trash-alt"></i> X√≥a ng√†y
                        </button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('updateTimeBtn').addEventListener('click', updateDayTime);
                    document.getElementById('deleteDayBtn').addEventListener('click', function() {
                        showDeleteConfirmation(dateStr);
                    });
                    
                    const lunchToggle = document.getElementById('lunchOvertimeToggle');
                    const toggleStatus = document.getElementById('toggleStatus');
                    
                    lunchToggle.addEventListener('change', function() {
                        toggleStatus.textContent = this.checked ? 'B·∫¨T' : 'T·∫ÆT';
                        toggleStatus.classList.toggle('active', this.checked);
                    });
                }, 100);
            } else {
                dayDetailElement.innerHTML = `
                    <div style="text-align:center;padding:30px;color:var(--gray);">
                        <i class="fas fa-calendar-times" style="font-size:40px;margin-bottom:10px;"></i>
                        <p>Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng cho ng√†y ${dateStr}</p>
                        <button class="btn btn-secondary btn-small" id="createDayRecordBtn" style="margin-top:10px;">
                            <i class="fas fa-plus"></i> T·∫°o b·∫£n ghi m·ªõi
                        </button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('createDayRecordBtn').addEventListener('click', function() {
                        createNewDayRecord(dateStr);
                    });
                }, 100);
            }
            
            hideMonthModal();
            document.getElementById('dayDetailModal').style.display = 'flex';
        }

        function showDeleteConfirmation(dateStr) {
            dateToDelete = dateStr;
            document.getElementById('modalDeleteMessage').textContent = 
                `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ªØ li·ªáu ch·∫•m c√¥ng c·ªßa ng√†y ${dateStr}?`;
            document.getElementById('confirmDeleteModal').style.display = 'flex';
        }

        function confirmDeleteDay() {
            if (!dateToDelete) return;
            
            const recordIndex = workData.findIndex(record => record.date === dateToDelete);
            
            if (recordIndex >= 0) {
                workData.splice(recordIndex, 1);
                saveDataToStorage();
                updateWorkHistory();
                
                const [day, month, year] = dateToDelete.split('/');
                const dateObj = new Date(year, month - 1, day);
                const deleteMonth = dateObj.getMonth();
                const deleteYear = dateObj.getFullYear();
                
                if (deleteMonth === currentMonth && deleteYear === currentYear) {
                    renderCalendar(currentMonth, currentYear);
                }
                
                hideDayModal();
                hideDeleteModal();
                showNotification(`üóëÔ∏è ƒê√£ x√≥a d·ªØ li·ªáu ng√†y ${dateToDelete}`, 'success');
            }
            
            dateToDelete = null;
        }

        function updateDayTime() {
            const startTimeInput = document.getElementById('editStartTime').value;
            const endTimeInput = document.getElementById('editEndTime').value;
            const manualOvertimeInput = document.getElementById('editManualOvertime').value;
            const lunchToggle = document.getElementById('lunchOvertimeToggle');
            
            if (!startTimeInput) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p gi·ªù b·∫Øt ƒë·∫ßu', 'warning');
                return;
            }
            
            const [startHour, startMinute] = startTimeInput.split(':').map(Number);
            const startTime = new Date(selectedDate);
            startTime.setHours(startHour, startMinute, 0, 0);
            
            let endTime = null;
            let workDuration = 0;
            let overtime = 0;
            let earlyOvertimeNew = 0;
            let lateOvertimeNew = 0;
            let isAutoEndedNew = false;
            
            if (endTimeInput) {
                const [endHour, endMinute] = endTimeInput.split(':').map(Number);
                endTime = new Date(selectedDate);
                endTime.setHours(endHour, endMinute, 0, 0);
                
                if (endTime <= startTime) {
                    showNotification('‚ö†Ô∏è Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu', 'warning');
                    return;
                }
                
                workDuration = calculateWorkDuration(startTime, endTime);
                
                const isWeekdayDetail = selectedDate.getDay() >= 1 && selectedDate.getDay() <= 6;
                
                if (isWeekdayDetail) {
                    const standardStartTime = new Date(startTime);
                    standardStartTime.setHours(7, 45, 0, 0);
                    
                    if (startTime < standardStartTime) {
                        earlyOvertimeNew = calculateWorkDuration(startTime, standardStartTime);
                    }
                    
                    const standardEndTime = new Date(startTime);
                    standardEndTime.setHours(17, 0, 0, 0);
                    
                    if (endTime > standardEndTime) {
                        lateOvertimeNew = calculateWorkDuration(standardEndTime, endTime);
                    }
                    
                    if (endTime.getHours() === 17 && endTime.getMinutes() === 0) {
                        isAutoEndedNew = true;
                    }
                    
                    overtime = earlyOvertimeNew + lateOvertimeNew;
                } else {
                    overtime = workDuration;
                }
            }
            
            const manualOvertime = parseFloat(manualOvertimeInput) || 0;
            const lunchOvertime = lunchToggle.checked ? 1 : 0;
            const totalOvertime = overtime + lunchOvertime + manualOvertime;
            
            const recordIndex = workData.findIndex(record => record.date === formatDate(selectedDate));
            
            if (recordIndex >= 0) {
                workData[recordIndex] = {
                    ...workData[recordIndex],
                    startTime: formatTime(startTime),
                    endTime: endTime ? formatTime(endTime) : null,
                    totalHours: workDuration.toFixed(2),
                    overtime: totalOvertime.toFixed(2),
                    manualOvertime: manualOvertime.toFixed(2),
                    lunchOvertime: lunchOvertime,
                    earlyOvertime: earlyOvertimeNew.toFixed(2),
                    lateOvertime: lateOvertimeNew.toFixed(2),
                    isAutoEnded: isAutoEndedNew,
                    timestamp: startTime.getTime(),
                    isWeekday: selectedDate.getDay() >= 1 && selectedDate.getDay() <= 6,
                    isAutoStarted: false
                };
            } else {
                const isWeekdayNew = selectedDate.getDay() >= 1 && selectedDate.getDay() <= 6;
                
                workData.unshift({
                    id: Date.now(),
                    date: formatDate(selectedDate),
                    dateISO: formatDateISO(startTime),
                    startTime: formatTime(startTime),
                    endTime: endTime ? formatTime(endTime) : null,
                    totalHours: workDuration.toFixed(2),
                    overtime: totalOvertime.toFixed(2),
                    manualOvertime: manualOvertime.toFixed(2),
                    lunchOvertime: lunchOvertime,
                    earlyOvertime: earlyOvertimeNew.toFixed(2),
                    lateOvertime: lateOvertimeNew.toFixed(2),
                    isAutoEnded: isAutoEndedNew,
                    timestamp: startTime.getTime(),
                    isWeekday: isWeekdayNew,
                    isAutoStarted: false
                });
            }
            
            saveDataToStorage();
            updateWorkHistory();
            renderCalendar(currentMonth, currentYear);
            hideDayModal();
            showNotification('üíæ ƒê√£ c·∫≠p nh·∫≠t gi·ªù l√†m vi·ªác', 'success');
        }

        function createNewDayRecord(dateStr) {
            const date = parseDateString(dateStr);
            const isWeekdayNew = date.getDay() >= 1 && date.getDay() <= 6;
            
            const workRecord = {
                id: Date.now(),
                date: dateStr,
                dateISO: formatDateISO(date),
                startTime: '07:45',
                endTime: null,
                totalHours: '0.00',
                overtime: '0.00',
                manualOvertime: '0.00',
                lunchOvertime: 0,
                earlyOvertime: 0,
                lateOvertime: 0,
                isAutoEnded: false,
                timestamp: date.getTime(),
                isWeekday: isWeekdayNew,
                isAutoStarted: false
            };
            
            workData.unshift(workRecord);
            saveDataToStorage();
            updateWorkHistory();
            initSalaryMonthSelect();
            showDayDetail(dateStr);
            showNotification('‚ûï ƒê√£ t·∫°o b·∫£n ghi m·ªõi cho ng√†y ' + dateStr, 'success');
        }

        function calculateSalary() {
            const basicSalaryInput = document.getElementById('basicSalary');
            const selectedMonthInput = document.getElementById('selectedMonth');
            
            const salary = parseInt(basicSalaryInput.value) || 0;
            const selectedMonthYear = selectedMonthInput.value;
            
            if (salary <= 0) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p l∆∞∆°ng cƒÉn b·∫£n h·ª£p l·ªá', 'warning');
                return;
            }
            
            if (!selectedMonthYear) {
                showNotification('‚ö†Ô∏è Vui l√≤ng ch·ªçn th√°ng', 'warning');
                return;
            }
            
            const [month, year] = selectedMonthYear.split('/').map(Number);
            
            const monthData = workData.filter(record => {
                const recordDate = new Date(record.timestamp);
                const recordMonth = recordDate.getMonth() + 1;
                const recordYear = recordDate.getFullYear();
                return recordMonth === month && recordYear === year && record.endTime;
            });
            
            let totalOvertimeHours = 0;
            let totalDays = 0;
            let detailHTML = '';
            
            monthData.forEach(record => {
                const overtime = parseFloat(record.overtime);
                if (overtime > 0) {
                    totalOvertimeHours += overtime;
                    totalDays++;
                    const earlyOvertime = parseFloat(record.earlyOvertime || 0);
                    const lateOvertime = parseFloat(record.lateOvertime || 0);
                    const lunchOvertime = record.lunchOvertime || 0;
                    
                    let detailText = `${overtime.toFixed(2)} gi·ªù`;
                    let components = [];
                    if (earlyOvertime > 0) components.push(`‚è∞ s·ªõm: ${earlyOvertime.toFixed(2)}h`);
                    if (lateOvertime > 0) components.push(`üïî mu·ªôn: ${lateOvertime.toFixed(2)}h`);
                    if (lunchOvertime > 0) components.push(`üç¥ tr∆∞a: ${lunchOvertime}h`);
                    
                    if (components.length > 0) {
                        detailText += ` (${components.join(', ')})`;
                    }
                    
                    detailHTML += `<div><span>${record.date}:</span><span>${detailText}</span></div>`;
                }
            });
            
            const dailySalary = salary / 26;
            const hourlySalary = dailySalary / 8;
            const overtimeRate = 2;
            const totalSalary = totalOvertimeHours * (hourlySalary * overtimeRate);
            
            const formattedSalary = formatCurrency(totalSalary);
            const formattedHourlySalary = formatCurrency(hourlySalary);
            
            document.getElementById('salaryAmount').textContent = formattedSalary;
            
            let details = `
                <div><span>T·ªïng gi·ªù tƒÉng ca:</span><span>${totalOvertimeHours.toFixed(2)} gi·ªù</span></div>
                <div><span>S·ªë ng√†y c√≥ tƒÉng ca:</span><span>${totalDays} ng√†y</span></div>
                <div><span>L∆∞∆°ng m·ªôt gi·ªù:</span><span>${formattedHourlySalary}/gi·ªù</span></div>
                <div><span>H·ªá s·ªë tƒÉng ca:</span><span>${overtimeRate}</span></div>
            `;
            
            if (detailHTML) {
                details += `
                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.1);">
                        <div style="font-weight:600;margin-bottom:5px;">Chi ti·∫øt t·ª´ng ng√†y:</div>
                        ${detailHTML}
                    </div>
                `;
            }
            
            document.getElementById('salaryDetails').innerHTML = details;
            document.getElementById('salaryResult').style.display = 'block';
            
            showNotification(`üí∞ ƒê√£ t√≠nh l∆∞∆°ng tƒÉng ca th√°ng ${month}/${year}`, 'success');
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', {
                style: 'currency',
                currency: 'VND'
            });
        }

        function exportData() {
            try {
                const exportData = {
                    workData: workData,
                    basicSalary: basicSalary,
                    exportDate: new Date().toISOString(),
                    appVersion: '2.0',
                    totalRecords: workData.length
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                const fileName = `chamcong_backup_${formatDateISO(new Date())}.json`;
                
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                saveBackupInfo();
                showNotification('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng', 'success');
                
            } catch (error) {
                console.error('L·ªói khi xu·∫•t d·ªØ li·ªáu:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t d·ªØ li·ªáu', 'danger');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileRecords = document.getElementById('fileRecords');
            const confirmBtn = document.getElementById('confirmImportBtn');
            
            fileName.textContent = file.name;
            fileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const backupData = JSON.parse(content);
                    
                    if (!backupData.workData || !Array.isArray(backupData.workData)) {
                        throw new Error('File kh√¥ng h·ª£p l·ªá');
                    }
                    
                    fileRecords.textContent = backupData.workData.length;
                    fileInfo.style.display = 'block';
                    confirmBtn.disabled = false;
                    
                } catch (error) {
                    console.error('L·ªói khi ƒë·ªçc file:', error);
                    fileRecords.textContent = 'L·ªói';
                    confirmBtn.disabled = true;
                    showNotification('‚ùå File kh√¥ng h·ª£p l·ªá', 'danger');
                }
            };
            
            reader.readAsText(file);
        }

        function importData() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ö†Ô∏è Vui l√≤ng ch·ªçn file', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const backupData = JSON.parse(content);
                    
                    if (!backupData.workData || !Array.isArray(backupData.workData)) {
                        throw new Error('File kh√¥ng h·ª£p l·ªá');
                    }
                    
                    workData = backupData.workData;
                    basicSalary = backupData.basicSalary || 0;
                    
                    document.getElementById('basicSalary').value = basicSalary;
                    saveBasicSalary();
                    saveDataToStorage();
                    updateWorkHistory();
                    initSalaryMonthSelect();
                    updateBackupStats();
                    
                    hideImportModal();
                    showNotification('‚úÖ ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng', 'success');
                    
                } catch (error) {
                    console.error('L·ªói khi nh·∫≠p d·ªØ li·ªáu:', error);
                    showNotification('‚ùå L·ªói khi nh·∫≠p d·ªØ li·ªáu', 'danger');
                }
            };
            
            reader.readAsText(file);
        }

        function backupToCloud() {
            // ƒê√¢y l√† t√≠nh nƒÉng sao l∆∞u ƒë√°m m√¢y gi·∫£ l·∫≠p
            // Trong th·ª±c t·∫ø, b·∫°n c√≥ th·ªÉ t√≠ch h·ª£p v·ªõi Google Drive, iCloud, etc.
            
            try {
                saveDataToStorage();
                saveBackupInfo();
                
                showNotification('‚òÅÔ∏è ƒê√£ sao l∆∞u d·ªØ li·ªáu c·ª•c b·ªô th√†nh c√¥ng', 'info');
                
                // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n sao l∆∞u th·ªß c√¥ng
                setTimeout(() => {
                    if (confirm('üì± Mu·ªën sao l∆∞u ra ngo√†i?\n\n1. Nh·∫•n "Xu·∫•t D·ªØ Li·ªáu"\n2. L∆∞u file v√†o iCloud/Google Drive\n3. Ho·∫∑c g·ª≠i email cho ch√≠nh m√¨nh\n\nB·∫•m OK ƒë·ªÉ xu·∫•t file ngay.')) {
                        exportData();
                    }
                }, 500);
                
            } catch (error) {
                showNotification('‚ùå L·ªói khi sao l∆∞u', 'danger');
            }
        }

        function restoreFromCloud() {
            // T√≠nh nƒÉng kh√¥i ph·ª•c t·ª´ ƒë√°m m√¢y gi·∫£ l·∫≠p
            showNotification('üì• Vui l√≤ng s·ª≠ d·ª•ng t√≠nh nƒÉng "Nh·∫≠p D·ªØ Li·ªáu" ƒë·ªÉ kh√¥i ph·ª•c t·ª´ file ƒë√£ sao l∆∞u', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            let bgColor = 'var(--primary)';
            if (type === 'success') bgColor = 'var(--success)';
            if (type === 'warning') bgColor = 'var(--warning)';
            if (type === 'danger') bgColor = 'var(--danger)';
            
            notification.style.backgroundColor = bgColor;
            notification.className = 'notification';
            notification.classList.add(type);
            messageElement.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Th√™m c√°c event listeners cho iOS
        if (isIOS) {
            window.addEventListener('pagehide', function() {
                saveDataToStorage();
                console.log('iOS: L∆∞u d·ªØ li·ªáu khi pagehide');
            });
            
            window.addEventListener('unload', function() {
                saveDataToStorage();
                console.log('iOS: L∆∞u d·ªØ li·ªáu khi unload');
            });
            
            // L∆∞u d·ªØ li·ªáu khi app b·ªã treo
            window.addEventListener('blur', function() {
                if (isWorking) {
                    saveDataToStorage();
                    console.log('iOS: L∆∞u d·ªØ li·ªáu khi m·∫•t focus');
                }
            });
        }
    </script>
</body>
</html>
