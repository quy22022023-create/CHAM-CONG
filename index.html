<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chấm Công Tăng Ca</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',-apple-system,sans-serif;}
        :root{--primary:#007AFF;--success:#34C759;--warning:#FF9500;--danger:#FF3B30;--light:#F2F2F7;--dark:#1D1D1F;--gray:#8E8E93;--border:#C7C7CC;--card-bg:#FFFFFF;--sunday:#FF2D55;--salary:#5856D6;--toggle-on:#34C759;--toggle-off:#E5E5EA;}
        body{background-color:var(--light);color:var(--dark);line-height:1.5;max-width:100%;overflow-x:hidden;padding-bottom:env(safe-area-inset-bottom);-webkit-tap-highlight-color:transparent;}
        .header{background:linear-gradient(135deg,var(--primary),#5856D6);color:white;padding-top:env(safe-area-inset-top);padding-bottom:20px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
        .header-content{padding:15px 20px;}
        .header h1{font-size:24px;font-weight:700;margin-bottom:5px;}
        .header p{opacity:0.9;font-size:14px;font-weight:400;}
        .current-time{background-color:var(--card-bg);margin:15px;padding:15px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);text-align:center;}
        .current-time h2{font-size:18px;margin-bottom:10px;color:var(--primary);display:flex;align-items:center;justify-content:center;gap:10px;}
        .time-display{font-size:32px;font-weight:700;color:var(--dark);margin:10px 0;}
        .date-display{font-size:16px;color:var(--gray);font-weight:500;}
        .day-indicator{display:inline-flex;align-items:center;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;margin-top:8px;background-color:rgba(255,255,255,0.2);}
        .day-indicator.sunday{background-color:var(--sunday);}
        .container{max-width:100%;padding:0 15px 20px;}
        .card{background-color:var(--card-bg);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
        .card h2{font-size:18px;margin-bottom:15px;color:var(--dark);display:flex;align-items:center;gap:10px;}
        .card h2 i{color:var(--primary);}
        .controls{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;}
        .btn{background-color:var(--primary);color:white;border:none;border-radius:12px;padding:16px 10px;font-size:17px;font-weight:600;text-align:center;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;-webkit-tap-highlight-color:transparent;}
        .btn:active{transform:scale(0.97);}
        .btn-full{width:100%;}
        .btn-start{background-color:var(--success);}
        .btn-start:active{background-color:#2DAE4A;}
        .btn-start.auto-activated{background-color:#2DAE4A;border:2px solid #1E8C3E;}
        .btn-end{background-color:var(--warning);}
        .btn-end:active{background-color:#E68500;}
        .btn-overtime-confirm{background-color:#AF52DE;margin-top:10px;}
        .btn-overtime-confirm:active{background-color:#9B45C7;}
        .btn-salary-control{background:linear-gradient(135deg,var(--salary),#7D3CFF);margin-top:10px;grid-column:span 2;animation:pulse 2s infinite;}
        @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.02);}100%{transform:scale(1);}}
        .btn-salary-control:active{transform:scale(0.97);animation:none;}
        .btn-small{padding:10px 15px;font-size:14px;border-radius:10px;}
        .btn-secondary{background-color:var(--light);color:var(--dark);border:1px solid var(--border);}
        .btn-secondary:active{background-color:#E5E5EA;}
        .btn-month{background-color:#5AC8FA;margin-top:15px;}
        .btn-month:active{background-color:#4AA8D8;}
        .btn-lunch{background-color:#FF9500;margin-top:10px;}
        .btn-lunch:active{background-color:#E68500;}
        .btn-salary{background-color:var(--salary);margin-top:10px;}
        .btn-salary:active{background-color:#4A4AC8;}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none !important;}
        .auto-start-info{background-color:rgba(52,199,89,0.1);border-radius:10px;padding:12px;margin-top:10px;text-align:center;font-size:14px;color:var(--success);display:flex;align-items:center;justify-content:center;gap:8px;}
        .auto-start-info i{font-size:16px;}
        .work-info{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}
        .info-box{background-color:var(--light);border-radius:12px;padding:15px;text-align:center;}
        .info-box h3{font-size:14px;color:var(--gray);margin-bottom:5px;font-weight:500;}
        .info-value{font-size:20px;font-weight:700;color:var(--dark);}
        .info-unit{font-size:14px;color:var(--gray);margin-left:2px;}
        .expected-salary{background-color:rgba(88,86,214,0.1);border-radius:12px;padding:15px;margin-top:15px;text-align:center;border:2px solid var(--salary);}
        .expected-salary h4{color:var(--salary);margin-bottom:5px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;}
        .expected-amount{font-size:22px;font-weight:700;color:var(--salary);}
        .work-history{max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
        .history-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid var(--light);}
        .history-item:last-child{border-bottom:none;}
        .history-date{font-weight:600;font-size:16px;color:var(--dark);}
        .history-time{font-size:14px;color:var(--gray);}
        .history-overtime{font-weight:700;font-size:16px;color:var(--success);}
        .delete-section{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
        .month-select{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background-color:white;font-size:16px;margin-right:10px;}
        .footer{text-align:center;padding:20px;color:var(--gray);font-size:14px;border-top:1px solid var(--border);margin-top:10px;}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;padding:20px;overflow-y:auto;}
        .modal-content{background-color:white;border-radius:16px;padding:25px;width:100%;max-width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.2);max-height:90vh;overflow-y:auto;}
        .modal h3{font-size:20px;margin-bottom:15px;color:var(--dark);display:flex;align-items:center;justify-content:space-between;}
        .modal h3 .close-btn{background:none;border:none;color:var(--gray);font-size:24px;cursor:pointer;padding:0;}
        .modal p{margin-bottom:20px;color:var(--gray);line-height:1.6;}
        .modal-buttons{display:flex;gap:10px;margin-top:20px;}
        .calendar{width:100%;}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .calendar-month-year{font-size:18px;font-weight:600;color:var(--dark);}
        .calendar-nav{display:flex;gap:10px;}
        .calendar-nav-btn{background-color:var(--light);border:none;border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:10px;text-align:center;font-weight:600;font-size:14px;color:var(--gray);}
        .calendar-weekdays div{padding:8px 0;}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;font-size:16px;font-weight:500;cursor:pointer;transition:all 0.2s;position:relative;}
        .calendar-day:hover{background-color:var(--light);}
        .calendar-day.empty{background-color:transparent;cursor:default;}
        .calendar-day.today{background-color:rgba(0,122,255,0.1);color:var(--primary);font-weight:700;}
        .calendar-day.has-data{background-color:rgba(52,199,89,0.1);}
        .calendar-day.sunday{color:var(--sunday);}
        .calendar-day.selected{background-color:var(--primary);color:white;}
        .day-overtime{font-size:10px;margin-top:2px;color:var(--success);font-weight:700;}
        .day-lunch{position:absolute;top:2px;right:2px;width:6px;height:6px;background-color:var(--warning);border-radius:50%;}
        .day-detail{margin-bottom:20px;}
        .day-detail-info{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}
        .detail-box{background-color:var(--light);border-radius:12px;padding:15px;text-align:center;}
        .detail-box h4{font-size:14px;color:var(--gray);margin-bottom:5px;font-weight:500;}
        .detail-value{font-size:18px;font-weight:700;color:var(--dark);}
        .edit-time{display:flex;gap:10px;margin-bottom:15px;align-items:center;}
        .time-input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background-color:white;font-size:16px;text-align:center;}
        .edit-overtime{margin-bottom:15px;}
        .edit-overtime label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);}
        .overtime-input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background-color:white;font-size:16px;text-align:center;}
        .edit-buttons{display:flex;gap:10px;margin-top:10px;}
        .salary-input-group{margin-bottom:20px;}
        .salary-input-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);}
        .salary-input{width:100%;padding:15px;border:1px solid var(--border);border-radius:12px;font-size:18px;font-weight:600;text-align:right;background-color:var(--light);}
        .salary-input:focus{outline:none;border-color:var(--primary);}
        .salary-result{background-color:rgba(88,86,214,0.1);border-radius:12px;padding:20px;margin-top:20px;text-align:center;border:2px solid var(--salary);}
        .salary-result h4{color:var(--salary);margin-bottom:10px;font-size:16px;}
        .salary-amount{font-size:28px;font-weight:700;color:var(--salary);margin-bottom:5px;}
        .salary-details{font-size:14px;color:var(--gray);margin-top:10px;text-align:left;}
        .salary-details div{margin-bottom:5px;display:flex;justify-content:space-between;}
        .notification{position:fixed;top:100px;right:20px;background-color:var(--success);color:white;padding:15px 20px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1001;transform:translateX(150%);transition:transform 0.3s ease;max-width:300px;}
        .notification.show{transform:translateX(0);}
        .notification.warning{background-color:var(--warning);}
        .notification.info{background-color:var(--primary);}
        .info-message{background-color:rgba(0,122,255,0.1);border-radius:12px;padding:15px;margin-bottom:20px;border-left:4px solid var(--primary);}
        .info-message h4{color:var(--primary);margin-bottom:5px;font-size:16px;display:flex;align-items:center;gap:8px;}
        
        /* Toggle Switch Styles */
        .toggle-container{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:15px;background-color:var(--light);border-radius:12px;}
        .toggle-label{font-weight:600;color:var(--dark);display:flex;align-items:center;gap:10px;}
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;}
        .toggle-switch input{opacity:0;width:0;height:0;}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--toggle-off);transition:.4s;border-radius:34px;}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%;}
        input:checked + .toggle-slider{background-color:var(--toggle-on);}
        input:checked + .toggle-slider:before{transform:translateX(26px);}
        .toggle-status{font-size:14px;font-weight:600;color:var(--gray);}
        .toggle-status.active{color:var(--success);}
        
        /* Overtime Status */
        .overtime-status{background-color:rgba(175,82,222,0.1);border-radius:10px;padding:12px;margin-top:10px;text-align:center;font-size:14px;color:#AF52DE;display:flex;align-items:center;justify-content:center;gap:8px;}
        .overtime-status.confirmed{background-color:rgba(52,199,89,0.1);color:var(--success);}
        .overtime-status.pending{background-color:rgba(255,149,0,0.1);color:var(--warning);}
        
        @media (max-width:350px){.controls{grid-template-columns:1fr;}.btn-salary-control{grid-column:span 1;}.work-info{grid-template-columns:1fr;}.modal-content{padding:15px;}.edit-time{flex-direction:column;}}
        .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:white;animation:spin 1s ease-in-out infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        @supports (-webkit-touch-callout:none){.btn,.month-select,.time-input,.salary-input,.overtime-input{-webkit-appearance:none;}.btn{-webkit-tap-highlight-color:transparent;}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-clock"></i> Chấm Công Tăng Ca</h1>
            <p>Giờ làm việc: 7:45 - 17:00 (T2-T7) | Chủ nhật: Toàn bộ là tăng ca</p>
            <div class="day-indicator" id="dayIndicator">
                <i class="fas fa-calendar-day"></i> <span id="dayName">Đang tải...</span>
            </div>
        </div>
    </header>

    <div class="current-time">
        <h2><i class="fas fa-calendar-alt"></i> Hôm nay</h2>
        <div class="date-display" id="currentDate">Đang tải...</div>
        <div class="time-display" id="currentTime">00:00:00</div>
        <div id="workStatus" style="color: var(--primary); font-weight: 600; margin-top: 5px;">Chưa bắt đầu làm việc</div>
    </div>

    <div class="container">
        <div class="info-message">
            <h4><i class="fas fa-info-circle"></i> Logic chấm công mới</h4>
            <p><strong>Thứ 2 - Thứ 7:</strong> Tự động bắt đầu 7:45, nếu ấn "Bắt đầu" trước 7:45 thì trước 7:45 là tăng ca. Mặc định tan ca 17:00 nếu không xác nhận tăng ca.</p>
            <p><strong>Chủ nhật:</strong> Toàn bộ thời gian từ Bắt đầu đến Tan ca đều tính là tăng ca.</p>
            <p><strong>Xác nhận tăng ca:</strong> Chỉ dành cho ngày trong tuần, nếu làm sau 17:00 phải xác nhận.</p>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-play-circle"></i> Điều khiển</h2>
            <div class="controls">
                <button class="btn btn-start" id="startWorkBtn">
                    <i class="fas fa-play"></i> Bắt đầu
                </button>
                <button class="btn btn-end" id="endWorkBtn">
                    <i class="fas fa-stop"></i> Tan ca
                </button>
            </div>
            
            <div id="autoStartInfo" class="auto-start-info" style="display: none;">
                <i class="fas fa-robot"></i> Tự động kích hoạt lúc 7:45 (T2-T7)
            </div>
            
            <div id="overtimeStatus" class="overtime-status pending" style="display: none;">
                <i class="fas fa-clock"></i> Chưa xác nhận tăng ca (mặc định tan ca 17:00)
            </div>
            
            <div class="work-info">
                <div class="info-box">
                    <h3>Giờ bắt đầu</h3>
                    <div class="info-value" id="startTime">--:--</div>
                </div>
                <div class="info-box">
                    <h3>Giờ kết thúc</h3>
                    <div class="info-value" id="endTime">--:--</div>
                </div>
                <div class="info-box">
                    <h3>Tổng thời gian</h3>
                    <div class="info-value" id="totalTime">0<span class="info-unit">giờ</span></div>
                </div>
                <div class="info-box">
                    <h3>Tăng ca hôm nay</h3>
                    <div class="info-value" id="overtime">0<span class="info-unit">giờ</span></div>
                </div>
            </div>
            
            <div class="expected-salary" id="expectedSalary" style="display: none;">
                <h4><i class="fas fa-coins"></i> Lương tăng ca dự kiến hôm nay</h4>
                <div class="expected-amount" id="expectedAmount">0 VNĐ</div>
            </div>
            
            <button class="btn btn-overtime-confirm btn-full" id="confirmOvertimeBtn" style="display: none;">
                <i class="fas fa-check-circle"></i> Xác Nhận Có Tăng Ca
            </button>
            
            <button class="btn btn-salary-control btn-full" id="salaryBtn">
                <i class="fas fa-calculator"></i> Tính Lương Tăng Ca
            </button>
            
            <button class="btn btn-month btn-full" id="viewMonthBtn">
                <i class="fas fa-calendar-alt"></i> Xem Lịch Tháng
            </button>
        </div>

        <div class="card">
            <h2><i class="fas fa-history"></i> Lịch sử làm việc</h2>
            <div class="work-history" id="workHistory">
                <div style="text-align: center; padding: 30px; color: var(--gray);">
                    <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <p>Chưa có dữ liệu chấm công</p>
                </div>
            </div>
            
            <div class="delete-section">
                <select class="month-select" id="monthSelect">
                    <option value="">Chọn tháng để xóa</option>
                </select>
                <button class="btn btn-secondary btn-small" id="deleteMonthBtn">
                    <i class="fas fa-trash-alt"></i> Xóa
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Ứng dụng Chấm Công Tăng Ca &copy; 2023</p>
        <p>Dữ liệu được lưu trữ cục bộ trên thiết bị</p>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
            <p id="modalMessage">Bạn có chắc chắn muốn xóa dữ liệu này không?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Hủy</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>

    <div class="modal" id="monthCalendarModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calendar"></i> Lịch Tháng
                <button class="close-btn" id="closeMonthModal">&times;</button>
            </h3>
            <div class="calendar" id="monthCalendar"></div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calendar-day"></i> Chi Tiết Ngày
                <button class="close-btn" id="closeDayModal">&times;</button>
            </h3>
            <div class="day-detail" id="dayDetailContent"></div>
        </div>
    </div>

    <div class="modal" id="salaryModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calculator"></i> Tính Lương Tăng Ca
                <button class="close-btn" id="closeSalaryModal">&times;</button>
            </h3>
            
            <div class="salary-input-group">
                <label for="basicSalary">Lương căn bản (VNĐ)</label>
                <input type="number" id="basicSalary" class="salary-input" placeholder="Nhập lương căn bản" min="0" step="100000">
            </div>
            
            <div class="salary-input-group">
                <label for="selectedMonth">Chọn tháng</label>
                <select id="selectedMonth" class="month-select"></select>
            </div>
            
            <button class="btn btn-salary btn-full" id="calculateSalaryBtn">
                <i class="fas fa-calculator"></i> Tính Lương Tăng Ca
            </button>
            
            <div class="salary-result" id="salaryResult" style="display: none;">
                <h4>Lương tăng ca dự kiến tháng này</h4>
                <div class="salary-amount" id="salaryAmount">0 VNĐ</div>
                <div class="salary-details" id="salaryDetails"></div>
            </div>
            
            <div style="margin-top:20px;padding:15px;background-color:rgba(0,122,255,0.1);border-radius:12px;">
                <h4 style="color:var(--primary);margin-bottom:10px;font-size:14px;">
                    <i class="fas fa-info-circle"></i> Công thức tính
                </h4>
                <p style="font-size:13px;color:var(--gray);">
                    Tiền tăng ca = Số giờ tăng ca × (((Lương căn bản ÷ 26) ÷ 8) × 2)
                </p>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationMessage">Thao tác thành công!</div>
    </div>

    <script>
        let workStartTime = null;
        let workEndTime = null;
        let isWorking = false;
        let timerInterval = null;
        let workData = [];
        let deleteAction = null;
        let selectedMonth = null;
        let today = new Date();
        let dayOfWeek = today.getDay();
        let isSunday = (dayOfWeek === 0);
        let isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 6);
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        let selectedDate = null;
        let selectedDayData = null;
        let basicSalary = localStorage.getItem('basicSalary') || 0;
        let autoStartTriggered = false;
        let overtimeConfirmed = false;
        let earlyOvertime = 0; // Tăng ca sớm trước 7:45
        let lateOvertime = 0; // Tăng ca muộn sau 17:00

        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            console.log("Khởi động ứng dụng...");
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            updateDayName();
            loadWorkData();
            initMonthSelect();
            initSalaryMonthSelect();
            loadBasicSalary();
            
            document.getElementById('startWorkBtn').addEventListener('click', startWork);
            document.getElementById('endWorkBtn').addEventListener('click', endWork);
            document.getElementById('confirmOvertimeBtn').addEventListener('click', confirmOvertime);
            document.getElementById('deleteMonthBtn').addEventListener('click', showDeleteConfirm);
            document.getElementById('cancelBtn').addEventListener('click', hideModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
            document.getElementById('viewMonthBtn').addEventListener('click', function() { showMonthCalendar(); });
            document.getElementById('salaryBtn').addEventListener('click', function() { showSalaryModal(); });
            document.getElementById('closeMonthModal').addEventListener('click', hideMonthModal);
            document.getElementById('closeDayModal').addEventListener('click', hideDayModal);
            document.getElementById('closeSalaryModal').addEventListener('click', hideSalaryModal);
            document.getElementById('calculateSalaryBtn').addEventListener('click', calculateSalary);
            document.getElementById('basicSalary').addEventListener('change', saveBasicSalary);
            
            checkTodayWorkStatus();
            checkAutoStart();
            updateButtonStates();
            
            console.log("Dữ liệu đã tải:", workData.length, "bản ghi");
        }

        function updateCurrentTime() {
            const now = new Date();
            today = now;
            dayOfWeek = today.getDay();
            isSunday = (dayOfWeek === 0);
            isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 6);
            
            const dateStr = now.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('vi-VN');
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
            
            checkAutoStart();
        }

        function checkAutoStart() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDay = now.getDay();
            
            const isWeekdayAuto = (currentDay >= 1 && currentDay <= 6);
            
            if (isWeekdayAuto && currentHour >= 7 && currentMinute >= 45 && !autoStartTriggered) {
                if (!isWorking) {
                    autoStartWork();
                }
            }
        }

        function autoStartWork() {
            autoStartTriggered = true;
            
            const startTimeToday = new Date(today);
            startTimeToday.setHours(7, 45, 0, 0);
            
            const todayStr = formatDate(today);
            const todayRecord = workData.find(record => record.date === todayStr);
            
            if (todayRecord) {
                return;
            }
            
            workStartTime = startTimeToday;
            isWorking = true;
            
            document.getElementById('startTime').textContent = '07:45';
            document.getElementById('workStatus').textContent = 'Đang làm việc (tự động 7:45)';
            document.getElementById('workStatus').style.color = 'var(--success)';
            
            const startBtn = document.getElementById('startWorkBtn');
            startBtn.classList.add('auto-activated');
            
            const autoStartInfo = document.getElementById('autoStartInfo');
            autoStartInfo.style.display = 'flex';
            
            updateButtonStates();
            startTimer();
            createAutoWorkRecord();
            
            showNotification('Tự động bắt đầu làm việc từ 7:45 (thứ 2 - thứ 7)', 'info');
        }

        function createAutoWorkRecord() {
            const todayStr = formatDate(today);
            const startTimeToday = new Date(today);
            startTimeToday.setHours(7, 45, 0, 0);
            
            const workRecord = {
                id: Date.now(),
                date: todayStr,
                dateISO: formatDateISO(startTimeToday),
                startTime: '07:45',
                endTime: null,
                totalHours: '0.00',
                overtime: '0.00',
                manualOvertime: '0.00',
                lunchOvertime: 0,
                earlyOvertime: 0,
                lateOvertime: 0,
                overtimeConfirmed: false,
                timestamp: startTimeToday.getTime(),
                isWeekday: true,
                isAutoStarted: true
            };
            
            workData.unshift(workRecord);
            
            if (workData.length > 100) {
                workData = workData.slice(0, 100);
            }
            
            saveDataToStorage();
            updateWorkHistory();
        }

        function updateDayName() {
            const dayNames = ['Chủ nhật', 'Thứ hai', 'Thứ ba', 'Thứ tư', 'Thứ năm', 'Thứ sáu', 'Thứ bảy'];
            const dayName = dayNames[dayOfWeek];
            
            document.getElementById('dayName').textContent = dayName;
            
            const dayIndicator = document.getElementById('dayIndicator');
            if (isSunday) {
                dayIndicator.classList.add('sunday');
            } else {
                dayIndicator.classList.remove('sunday');
            }
        }

        function loadBasicSalary() {
            const savedSalary = localStorage.getItem('basicSalary');
            if (savedSalary) {
                basicSalary = parseInt(savedSalary);
                document.getElementById('basicSalary').value = basicSalary;
            }
        }

        function saveBasicSalary() {
            const salaryInput = document.getElementById('basicSalary');
            const salary = parseInt(salaryInput.value) || 0;
            basicSalary = salary;
            localStorage.setItem('basicSalary', salary.toString());
            showNotification('Đã lưu lương căn bản', 'success');
            updateExpectedSalary();
        }

        function updateExpectedSalary() {
            const expectedSalaryDiv = document.getElementById('expectedSalary');
            const expectedAmount = document.getElementById('expectedAmount');
            
            if (basicSalary > 0) {
                const todayStr = formatDate(today);
                const todayRecord = workData.find(record => record.date === todayStr);
                
                if (todayRecord && todayRecord.endTime) {
                    const overtime = parseFloat(todayRecord.overtime);
                    
                    if (overtime > 0) {
                        const dailySalary = basicSalary / 26;
                        const hourlySalary = dailySalary / 8;
                        const overtimeRate = 2;
                        const salary = overtime * (hourlySalary * overtimeRate);
                        
                        expectedAmount.textContent = formatCurrency(salary);
                        expectedSalaryDiv.style.display = 'block';
                    } else {
                        expectedSalaryDiv.style.display = 'none';
                    }
                } else {
                    expectedSalaryDiv.style.display = 'none';
                }
            } else {
                expectedSalaryDiv.style.display = 'none';
            }
        }

        function initSalaryMonthSelect() {
            const salaryMonthSelect = document.getElementById('selectedMonth');
            const months = new Set();
            
            const currentMonthYear = `${currentMonth + 1}/${currentYear}`;
            months.add(currentMonthYear);
            
            workData.forEach(record => {
                const date = new Date(record.timestamp);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                months.add(monthYear);
            });
            
            salaryMonthSelect.innerHTML = '';
            
            const monthsArray = Array.from(months).sort((a, b) => {
                const [aMonth, aYear] = a.split('/').map(Number);
                const [bMonth, bYear] = b.split('/').map(Number);
                
                if (aYear !== bYear) return bYear - aYear;
                return bMonth - aMonth;
            });
            
            monthsArray.forEach(monthYear => {
                const [month, year] = monthYear.split('/');
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = `Tháng ${month}/${year}`;
                if (monthYear === currentMonthYear) {
                    option.selected = true;
                }
                salaryMonthSelect.appendChild(option);
            });
        }

        function checkTodayWorkStatus() {
            const todayStr = formatDate(today);
            const todayRecord = workData.find(record => record.date === todayStr);
            
            if (todayRecord) {
                workStartTime = parseTimeString(todayRecord.startTime, today);
                workEndTime = todayRecord.endTime ? parseTimeString(todayRecord.endTime, today) : null;
                isWorking = !todayRecord.endTime;
                overtimeConfirmed = todayRecord.overtimeConfirmed || false;
                earlyOvertime = todayRecord.earlyOvertime || 0;
                lateOvertime = todayRecord.lateOvertime || 0;
                
                if (todayRecord.isAutoStarted) {
                    autoStartTriggered = true;
                    const startBtn = document.getElementById('startWorkBtn');
                    startBtn.classList.add('auto-activated');
                    
                    const autoStartInfo = document.getElementById('autoStartInfo');
                    autoStartInfo.style.display = 'flex';
                }
                
                document.getElementById('startTime').textContent = formatTime(workStartTime);
                
                if (workEndTime) {
                    document.getElementById('endTime').textContent = formatTime(workEndTime);
                    document.getElementById('workStatus').textContent = 'Đã kết thúc làm việc';
                    document.getElementById('workStatus').style.color = 'var(--warning)';
                    
                    const totalHours = parseFloat(todayRecord.totalHours);
                    const overtime = parseFloat(todayRecord.overtime);
                    
                    document.getElementById('totalTime').innerHTML = `${totalHours.toFixed(2)}<span class="info-unit">giờ</span>`;
                    document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">giờ</span>`;
                    
                    updateOvertimeStatusDisplay();
                    updateExpectedSalary();
                } else {
                    document.getElementById('endTime').textContent = '--:--';
                    document.getElementById('workStatus').textContent = 'Đang làm việc';
                    document.getElementById('workStatus').style.color = 'var(--success)';
                    startTimer();
                    updateOvertimeStatusDisplay();
                }
            }
            
            updateButtonStates();
        }

        function updateOvertimeStatusDisplay() {
            const overtimeStatus = document.getElementById('overtimeStatus');
            const confirmBtn = document.getElementById('confirmOvertimeBtn');
            
            if (isWorking && isWeekday) {
                overtimeStatus.style.display = 'flex';
                if (overtimeConfirmed) {
                    overtimeStatus.className = 'overtime-status confirmed';
                    overtimeStatus.innerHTML = '<i class="fas fa-check-circle"></i> Đã xác nhận có tăng ca';
                    confirmBtn.style.display = 'none';
                } else {
                    overtimeStatus.className = 'overtime-status pending';
                    overtimeStatus.innerHTML = '<i class="fas fa-clock"></i> Chưa xác nhận tăng ca (mặc định tan ca 17:00)';
                    confirmBtn.style.display = 'flex';
                }
            } else {
                overtimeStatus.style.display = 'none';
                confirmBtn.style.display = 'none';
            }
        }

        function updateButtonStates() {
            const startBtn = document.getElementById('startWorkBtn');
            const endBtn = document.getElementById('endWorkBtn');
            
            if (isWeekday) {
                startBtn.style.display = 'flex';
                endBtn.style.display = 'flex';
                
                if (isWorking) {
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    endBtn.disabled = true;
                }
            } else if (isSunday) {
                startBtn.style.display = 'flex';
                endBtn.style.display = 'flex';
                
                if (isWorking) {
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    endBtn.disabled = true;
                }
            }
        }

        function startWork() {
            if (isWorking) {
                showNotification('Bạn đã bắt đầu làm việc trước đó!', 'warning');
                return;
            }
            
            workStartTime = new Date();
            isWorking = true;
            overtimeConfirmed = false;
            
            document.getElementById('startTime').textContent = formatTime(workStartTime);
            document.getElementById('workStatus').textContent = 'Đang làm việc';
            document.getElementById('workStatus').style.color = 'var(--success)';
            
            const autoStartInfo = document.getElementById('autoStartInfo');
            autoStartInfo.style.display = 'none';
            
            const startBtn = document.getElementById('startWorkBtn');
            startBtn.classList.remove('auto-activated');
            
            updateButtonStates();
            startTimer();
            updateOvertimeStatusDisplay();
            
            const todayStr = formatDate(today);
            const autoRecordIndex = workData.findIndex(record => record.date === todayStr && record.isAutoStarted);
            if (autoRecordIndex >= 0) {
                workData.splice(autoRecordIndex, 1);
            }
            
            showNotification('Đã bắt đầu làm việc thủ công!', 'success');
        }

        function endWork() {
            if (!isWorking) {
                showNotification('Bạn chưa bắt đầu làm việc!', 'warning');
                return;
            }
            
            workEndTime = new Date();
            isWorking = false;
            
            stopTimer();
            
            // Tính toán theo logic mới
            const workDuration = calculateWorkDuration(workStartTime, workEndTime);
            let overtime = 0;
            let endTimeForCalculation = workEndTime;
            
            if (isWeekday) {
                // Ngày trong tuần
                if (!overtimeConfirmed) {
                    // Nếu chưa xác nhận tăng ca, mặc định tan ca 17:00
                    const defaultEndTime = new Date(workStartTime);
                    defaultEndTime.setHours(17, 0, 0, 0);
                    endTimeForCalculation = workEndTime > defaultEndTime ? defaultEndTime : workEndTime;
                }
                
                // Tính tăng ca sớm (trước 7:45)
                const standardStartTime = new Date(workStartTime);
                standardStartTime.setHours(7, 45, 0, 0);
                
                if (workStartTime < standardStartTime) {
                    earlyOvertime = calculateWorkDuration(workStartTime, standardStartTime);
                } else {
                    earlyOvertime = 0;
                }
                
                // Tính tăng ca muộn (sau 17:00)
                const standardEndTime = new Date(workStartTime);
                standardEndTime.setHours(17, 0, 0, 0);
                
                if (overtimeConfirmed && workEndTime > standardEndTime) {
                    lateOvertime = calculateWorkDuration(standardEndTime, workEndTime);
                } else {
                    lateOvertime = 0;
                }
                
                overtime = earlyOvertime + lateOvertime;
                
            } else if (isSunday) {
                // Chủ nhật: toàn bộ thời gian đều là tăng ca
                overtime = workDuration;
            }
            
            document.getElementById('endTime').textContent = formatTime(workEndTime);
            document.getElementById('totalTime').innerHTML = `${workDuration.toFixed(2)}<span class="info-unit">giờ</span>`;
            document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">giờ</span>`;
            document.getElementById('workStatus').textContent = 'Đã kết thúc làm việc';
            document.getElementById('workStatus').style.color = 'var(--warning)';
            
            updateButtonStates();
            saveWorkData(workStartTime, workEndTime, workDuration, overtime, endTimeForCalculation);
            updateWorkHistory();
            updateExpectedSalary();
            updateOvertimeStatusDisplay();
            
            showNotification(`Đã kết thúc làm việc. Tăng ca: ${overtime.toFixed(2)} giờ`, 'success');
        }

        function confirmOvertime() {
            if (!isWorking) {
                showNotification('Bạn không đang làm việc!', 'warning');
                return;
            }
            
            overtimeConfirmed = true;
            updateOvertimeStatusDisplay();
            showNotification('Đã xác nhận có tăng ca!', 'success');
        }

        function calculateWorkDuration(startTime, endTime) {
            const diffMs = endTime - startTime;
            const diffMinutes = diffMs / (1000 * 60);
            const diffHours = diffMinutes / 60;
            return diffHours;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN');
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseTimeString(timeStr, baseDate) {
            if (!timeStr) return null;
            
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date(baseDate);
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function parseDateString(dateStr) {
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (workStartTime && isWorking) {
                    const now = new Date();
                    const duration = calculateWorkDuration(workStartTime, now);
                    
                    // Tính tăng ca tạm thời để hiển thị
                    let overtime = 0;
                    
                    if (isWeekday) {
                        // Tính tăng ca sớm
                        const standardStartTime = new Date(workStartTime);
                        standardStartTime.setHours(7, 45, 0, 0);
                        
                        if (workStartTime < standardStartTime) {
                            earlyOvertime = calculateWorkDuration(workStartTime, standardStartTime);
                        }
                        
                        // Tính tăng ca muộn (nếu đã xác nhận và sau 17:00)
                        if (overtimeConfirmed) {
                            const standardEndTime = new Date(workStartTime);
                            standardEndTime.setHours(17, 0, 0, 0);
                            
                            if (now > standardEndTime) {
                                lateOvertime = calculateWorkDuration(standardEndTime, now);
                            }
                        }
                        
                        overtime = earlyOvertime + lateOvertime;
                    } else if (isSunday) {
                        // Chủ nhật: toàn bộ thời gian
                        overtime = duration;
                    }
                    
                    document.getElementById('totalTime').innerHTML = `${duration.toFixed(2)}<span class="info-unit">giờ</span>`;
                    document.getElementById('overtime').innerHTML = `${overtime.toFixed(2)}<span class="info-unit">giờ</span>`;
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function saveWorkData(startTime, endTime, totalHours, overtime, endTimeForCalculation = null) {
            const todayStr = formatDate(today);
            
            const existingIndex = workData.findIndex(record => record.date === todayStr);
            
            const workRecord = {
                id: Date.now(),
                date: todayStr,
                dateISO: formatDateISO(startTime),
                startTime: formatTime(startTime),
                endTime: endTime ? formatTime(endTime) : null,
                endTimeForCalculation: endTimeForCalculation ? formatTime(endTimeForCalculation) : formatTime(endTime),
                totalHours: totalHours.toFixed(2),
                overtime: overtime.toFixed(2),
                manualOvertime: '0.00',
                lunchOvertime: 0,
                earlyOvertime: earlyOvertime.toFixed(2),
                lateOvertime: lateOvertime.toFixed(2),
                overtimeConfirmed: overtimeConfirmed,
                timestamp: startTime.getTime(),
                isWeekday: isWeekday,
                isAutoStarted: false
            };
            
            if (existingIndex >= 0) {
                if (workData[existingIndex].lunchOvertime) {
                    workRecord.lunchOvertime = workData[existingIndex].lunchOvertime;
                    workRecord.overtime = (parseFloat(workRecord.overtime) + workRecord.lunchOvertime).toFixed(2);
                }
                if (workData[existingIndex].manualOvertime) {
                    workRecord.manualOvertime = workData[existingIndex].manualOvertime;
                    workRecord.overtime = (parseFloat(workRecord.overtime) + parseFloat(workRecord.manualOvertime)).toFixed(2);
                }
                
                workData[existingIndex] = workRecord;
            } else {
                workData.unshift(workRecord);
            }
            
            if (workData.length > 100) {
                workData = workData.slice(0, 100);
            }
            
            saveDataToStorage();
            updateMonthSelect();
            initSalaryMonthSelect();
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('workAttendanceData', JSON.stringify(workData));
                console.log('Đã lưu dữ liệu vào localStorage:', workData.length, 'bản ghi');
            } catch (error) {
                console.error('Lỗi khi lưu dữ liệu:', error);
                showNotification('Lỗi khi lưu dữ liệu', 'danger');
            }
        }

        function loadWorkData() {
            try {
                const savedData = localStorage.getItem('workAttendanceData');
                
                if (savedData) {
                    workData = JSON.parse(savedData);
                    console.log('Đã tải dữ liệu từ localStorage:', workData.length, 'bản ghi');
                    updateWorkHistory();
                    updateMonthSelect();
                    initSalaryMonthSelect();
                } else {
                    console.log('Không có dữ liệu cũ trong localStorage');
                    workData = [];
                }
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                workData = [];
                showNotification('Lỗi khi tải dữ liệu cũ', 'danger');
            }
        }

        function updateWorkHistory() {
            const historyContainer = document.getElementById('workHistory');
            
            if (workData.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>Chưa có dữ liệu chấm công</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            
            workData.forEach(record => {
                const isTodayRecord = record.date === formatDate(today);
                const todayClass = isTodayRecord ? 'style="color: var(--primary); font-weight: 700;"' : '';
                const totalOvertime = parseFloat(record.overtime);
                const lunchOvertime = record.lunchOvertime || 0;
                const autoStarted = record.isAutoStarted || false;
                const overtimeConfirmed = record.overtimeConfirmed || false;
                
                let overtimeIcon = '';
                if (record.isWeekday) {
                    if (overtimeConfirmed) {
                        overtimeIcon = '<i class="fas fa-check-circle" style="color: var(--success); margin-left: 5px;"></i>';
                    }
                }
                
                historyHTML += `
                    <div class="history-item">
                        <div>
                            <div class="history-date" ${todayClass}>${record.date} ${record.isWeekday ? '(T2-T7)' : '(CN)'} ${autoStarted ? '<i class="fas fa-robot" style="color: var(--success); margin-left: 5px;"></i>' : ''}${overtimeIcon}</div>
                            <div class="history-time">${record.startTime} - ${record.endTime || '--:--'}</div>
                        </div>
                        <div class="history-overtime">${record.endTime ? `+${totalOvertime.toFixed(2)} giờ` : 'Đang làm'} ${lunchOvertime > 0 ? '<i class="fas fa-utensils" style="color: var(--warning); margin-left: 5px;"></i>' : ''}</div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }

        function initMonthSelect() {
            updateMonthSelect();
        }

        function updateMonthSelect() {
            const monthSelect = document.getElementById('monthSelect');
            const months = new Set();
            
            workData.forEach(record => {
                const date = new Date(record.timestamp);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                months.add(monthYear);
            });
            
            while (monthSelect.options.length > 1) {
                monthSelect.remove(1);
            }
            
            const monthsArray = Array.from(months).sort((a, b) => {
                const [aMonth, aYear] = a.split('/').map(Number);
                const [bMonth, bYear] = b.split('/').map(Number);
                
                if (aYear !== bYear) return bYear - aYear;
                return bMonth - aMonth;
            });
            
            monthsArray.forEach(monthYear => {
                const [month, year] = monthYear.split('/');
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = `Tháng ${month}/${year}`;
                monthSelect.appendChild(option);
            });
            
            monthSelect.addEventListener('change', function() {
                selectedMonth = this.value;
            });
        }

        function showDeleteConfirm() {
            if (!selectedMonth) {
                showNotification('Vui lòng chọn tháng để xóa!', 'warning');
                return;
            }
            
            const [month, year] = selectedMonth.split('/');
            document.getElementById('modalMessage').textContent = 
                `Bạn có chắc chắn muốn xóa tất cả dữ liệu chấm công của tháng ${month}/${year}?`;
            
            deleteAction = 'month';
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('confirmModal').style.display = 'none';
            deleteAction = null;
        }

        function confirmDelete() {
            if (deleteAction === 'month' && selectedMonth) {
                deleteMonthData(selectedMonth);
            }
            
            hideModal();
        }

        function deleteMonthData(monthYear) {
            const [month, year] = monthYear.split('/').map(Number);
            
            const filteredData = workData.filter(record => {
                const recordDate = new Date(record.timestamp);
                const recordMonth = recordDate.getMonth() + 1;
                const recordYear = recordDate.getFullYear();
                
                return !(recordMonth === month && recordYear === year);
            });
            
            workData = filteredData;
            
            saveDataToStorage();
            
            updateWorkHistory();
            updateMonthSelect();
            initSalaryMonthSelect();
            
            selectedMonth = null;
            document.getElementById('monthSelect').value = '';
            
            showNotification(`Đã xóa dữ liệu tháng ${month}/${year}`, 'success');
        }

        function showSalaryModal() {
            document.getElementById('salaryModal').style.display = 'flex';
        }

        function showMonthCalendar() {
            renderCalendar(currentMonth, currentYear);
            document.getElementById('monthCalendarModal').style.display = 'flex';
        }

        function hideMonthModal() {
            document.getElementById('monthCalendarModal').style.display = 'none';
        }

        function hideDayModal() {
            document.getElementById('dayDetailModal').style.display = 'none';
        }

        function hideSalaryModal() {
            document.getElementById('salaryModal').style.display = 'none';
        }

        function renderCalendar(month, year) {
            const calendarElement = document.getElementById('monthCalendar');
            
            const monthNames = [
                'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
            ];
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();
            
            let calendarHTML = `
                <div class="calendar-header">
                    <div class="calendar-month-year">${monthNames[month]} ${year}</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                        <button class="calendar-nav-btn" id="todayMonthBtn">Hôm nay</button>
                        <button class="calendar-nav-btn" id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-weekdays">
                    <div>CN</div><div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div>
                </div>
                <div class="calendar-days">
            `;
            
            for (let i = 0; i < firstDayIndex; i++) {
                calendarHTML += `<div class="calendar-day empty"></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                const isToday = currentDate.toDateString() === today.toDateString();
                const isSunday = currentDate.getDay() === 0;
                
                const dayData = workData.find(record => record.date === dateStr);
                const hasData = !!dayData;
                const hasLunchOvertime = hasData && dayData.lunchOvertime > 0;
                const overtime = hasData ? parseFloat(dayData.overtime) : 0;
                const overtimeConfirmed = hasData ? (dayData.overtimeConfirmed || false) : false;
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (hasData) dayClass += ' has-data';
                if (isSunday) dayClass += ' sunday';
                
                calendarHTML += `
                    <div class="${dayClass}" data-date="${dateStr}">
                        ${day}
                        ${hasLunchOvertime ? '<div class="day-lunch"></div>' : ''}
                        ${overtimeConfirmed ? '<i class="fas fa-check-circle" style="color: var(--success); font-size: 10px; position: absolute; top: 2px; left: 2px;"></i>' : ''}
                        ${hasData && overtime > 0 ? `<div class="day-overtime">+${overtime.toFixed(1)}h</div>` : ''}
                    </div>
                `;
            }
            
            calendarHTML += `</div>`;
            calendarElement.innerHTML = calendarHTML;
            
            document.getElementById('prevMonthBtn').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            document.getElementById('nextMonthBtn').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            document.getElementById('todayMonthBtn').addEventListener('click', function() {
                const now = new Date();
                currentMonth = now.getMonth();
                currentYear = now.getFullYear();
                renderCalendar(currentMonth, currentYear);
            });
            
            setTimeout(() => {
                const dayElements = document.querySelectorAll('.calendar-day:not(.empty)');
                dayElements.forEach(dayElement => {
                    dayElement.addEventListener('click', function() {
                        const dateStr = this.getAttribute('data-date');
                        showDayDetail(dateStr);
                    });
                });
            }, 100);
        }

        function showDayDetail(dateStr) {
            selectedDate = parseDateString(dateStr);
            selectedDayData = workData.find(record => record.date === dateStr);
            
            const dayDetailElement = document.getElementById('dayDetailContent');
            
            if (selectedDayData) {
                const totalOvertime = parseFloat(selectedDayData.overtime);
                const lunchOvertime = selectedDayData.lunchOvertime || 0;
                const manualOvertime = parseFloat(selectedDayData.manualOvertime || 0);
                const earlyOvertime = parseFloat(selectedDayData.earlyOvertime || 0);
                const lateOvertime = parseFloat(selectedDayData.lateOvertime || 0);
                const workOvertime = totalOvertime - lunchOvertime - manualOvertime;
                const overtimeConfirmed = selectedDayData.overtimeConfirmed || false;
                const isWeekdayDetail = selectedDayData.isWeekday;
                
                let logicInfo = '';
                if (isWeekdayDetail) {
                    logicInfo = `
                        <div style="margin-bottom:15px;padding:12px;background-color:rgba(0,122,255,0.1);border-radius:10px;">
                            <div style="font-size:13px;color:var(--primary);">
                                <strong><i class="fas fa-calculator"></i> Logic tính tăng ca:</strong><br>
                                • Sớm trước 7:45: ${earlyOvertime.toFixed(2)} giờ<br>
                                • Muộn sau 17:00: ${lateOvertime.toFixed(2)} giờ<br>
                                • Trưa: ${lunchOvertime.toFixed(2)} giờ<br>
                                • Xác nhận tăng ca: ${overtimeConfirmed ? 'Có ✓' : 'Không (mặc định 17:00)'}
                            </div>
                        </div>
                    `;
                } else {
                    logicInfo = `
                        <div style="margin-bottom:15px;padding:12px;background-color:rgba(255,45,85,0.1);border-radius:10px;">
                            <div style="font-size:13px;color:var(--sunday);">
                                <strong><i class="fas fa-calculator"></i> Chủ nhật:</strong> Toàn bộ thời gian đều tính là tăng ca
                            </div>
                        </div>
                    `;
                }
                
                dayDetailElement.innerHTML = `
                    <div class="day-detail-info">
                        <div class="detail-box">
                            <h4>Ngày</h4>
                            <div class="detail-value">${dateStr}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Loại ngày</h4>
                            <div class="detail-value">${isWeekdayDetail ? 'T2-T7' : 'Chủ nhật'}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Giờ vào</h4>
                            <div class="detail-value">${selectedDayData.startTime}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Giờ tan</h4>
                            <div class="detail-value">${selectedDayData.endTime || '--:--'}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Tổng giờ</h4>
                            <div class="detail-value">${selectedDayData.totalHours} giờ</div>
                        </div>
                        <div class="detail-box">
                            <h4>Tăng ca</h4>
                            <div class="detail-value">${totalOvertime.toFixed(2)} giờ</div>
                        </div>
                    </div>
                    
                    ${logicInfo}
                    
                    <div class="edit-time">
                        <input type="time" id="editStartTime" class="time-input" value="${selectedDayData.startTime}">
                        <span>đến</span>
                        <input type="time" id="editEndTime" class="time-input" value="${selectedDayData.endTime || ''}">
                    </div>
                    
                    <div class="edit-overtime">
                        <label for="editManualOvertime">Sửa giờ tăng ca (giờ)</label>
                        <input type="number" id="editManualOvertime" class="overtime-input" value="${manualOvertime.toFixed(2)}" step="0.25" min="0">
                    </div>
                    
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <i class="fas fa-utensils" style="color: var(--warning);"></i>
                            <span>Tăng ca trưa (1 giờ)</span>
                        </div>
                        <div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="lunchOvertimeToggle" ${lunchOvertime > 0 ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-status ${lunchOvertime > 0 ? 'active' : ''}" id="toggleStatus">
                                ${lunchOvertime > 0 ? 'BẬT' : 'TẮT'}
                            </div>
                        </div>
                    </div>
                    
                    ${isWeekdayDetail ? `
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            <span>Xác nhận có tăng ca</span>
                        </div>
                        <div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="overtimeConfirmToggle" ${overtimeConfirmed ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="toggle-status ${overtimeConfirmed ? 'active' : ''}" id="overtimeConfirmStatus">
                                ${overtimeConfirmed ? 'ĐÃ XÁC NHẬN' : 'CHƯA XÁC NHẬN'}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="edit-buttons">
                        <button class="btn btn-secondary btn-small" id="updateTimeBtn">
                            <i class="fas fa-save"></i> Cập nhật
                        </button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('updateTimeBtn').addEventListener('click', updateDayTime);
                    
                    const lunchToggle = document.getElementById('lunchOvertimeToggle');
                    const toggleStatus = document.getElementById('toggleStatus');
                    
                    lunchToggle.addEventListener('change', function() {
                        toggleStatus.textContent = this.checked ? 'BẬT' : 'TẮT';
                        toggleStatus.classList.toggle('active', this.checked);
                    });
                    
                    const overtimeConfirmToggle = document.getElementById('overtimeConfirmToggle');
                    const overtimeConfirmStatus = document.getElementById('overtimeConfirmStatus');
                    
                    if (overtimeConfirmToggle) {
                        overtimeConfirmToggle.addEventListener('change', function() {
                            overtimeConfirmStatus.textContent = this.checked ? 'ĐÃ XÁC NHẬN' : 'CHƯA XÁC NHẬN';
                            overtimeConfirmStatus.classList.toggle('active', this.checked);
                        });
                    }
                }, 100);
            } else {
                dayDetailElement.innerHTML = `
                    <div style="text-align:center;padding:30px;color:var(--gray);">
                        <i class="fas fa-calendar-times" style="font-size:40px;margin-bottom:10px;"></i>
                        <p>Không có dữ liệu chấm công cho ngày ${dateStr}</p>
                        <button class="btn btn-secondary btn-small" id="createDayRecordBtn" style="margin-top:10px;">
                            <i class="fas fa-plus"></i> Tạo bản ghi mới
                        </button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('createDayRecordBtn').addEventListener('click', function() {
                        createNewDayRecord(dateStr);
                    });
                }, 100);
            }
            
            hideMonthModal();
            document.getElementById('dayDetailModal').style.display = 'flex';
        }

        function updateDayTime() {
            const startTimeInput = document.getElementById('editStartTime').value;
            const endTimeInput = document.getElementById('editEndTime').value;
            const manualOvertimeInput = document.getElementById('editManualOvertime').value;
            const lunchToggle = document.getElementById('lunchOvertimeToggle');
            const overtimeConfirmToggle = document.getElementById('overtimeConfirmToggle');
            
            if (!startTimeInput) {
                showNotification('Vui lòng nhập giờ bắt đầu', 'warning');
                return;
            }
            
            const [startHour, startMinute] = startTimeInput.split(':').map(Number);
            const startTime = new Date(selectedDate);
            startTime.setHours(startHour, startMinute, 0, 0);
            
            let endTime = null;
            let workDuration = 0;
            let overtime = 0;
            let earlyOvertimeNew = 0;
            let lateOvertimeNew = 0;
            
            if (endTimeInput) {
                const [endHour, endMinute] = endTimeInput.split(':').map(Number);
                endTime = new Date(selectedDate);
                endTime.setHours(endHour, endMinute, 0, 0);
                
                if (endTime <= startTime) {
                    showNotification('Giờ kết thúc phải sau giờ bắt đầu', 'warning');
                    return;
                }
                
                workDuration = calculateWorkDuration(startTime, endTime);
                
                const isWeekdayDetail = selectedDate.getDay() >= 1 && selectedDate.getDay() <= 6;
                
                if (isWeekdayDetail) {
                    // Tính tăng ca sớm (trước 7:45)
                    const standardStartTime = new Date(startTime);
                    standardStartTime.setHours(7, 45, 0, 0);
                    
                    if (startTime < standardStartTime) {
                        earlyOvertimeNew = calculateWorkDuration(startTime, standardStartTime);
                    }
                    
                    // Tính tăng ca muộn (sau 17:00)
                    const standardEndTime = new Date(startTime);
                    standardEndTime.setHours(17, 0, 0, 0);
                    
                    const overtimeConfirmedNew = overtimeConfirmToggle ? overtimeConfirmToggle.checked : false;
                    
                    if (overtimeConfirmedNew && endTime > standardEndTime) {
                        lateOvertimeNew = calculateWorkDuration(standardEndTime, endTime);
                    }
                    
                    overtime = earlyOvertimeNew + lateOvertimeNew;
                } else {
                    // Chủ nhật: toàn bộ thời gian
                    overtime = workDuration;
                }
            }
            
            const manualOvertime = parseFloat(manualOvertimeInput) || 0;
            const lunchOvertime = lunchToggle.checked ? 1 : 0;
            const overtimeConfirmedNew = overtimeConfirmToggle ? overtimeConfirmToggle.checked : false;
            const totalOvertime = overtime + lunchOvertime + manualOvertime;
            
            const recordIndex = workData.findIndex(record => record.date === formatDate(selectedDate));
            
            if (recordIndex >= 0) {
                workData[recordIndex] = {
                    ...workData[recordIndex],
                    startTime: formatTime(startTime),
                    endTime: endTime ? formatTime(endTime) : null,
                    totalHours: workDuration.toFixed(2),
                    overtime: totalOvertime.toFixed(2),
                    manualOvertime: manualOvertime.toFixed(2),
                    lunchOvertime: lunchOvertime,
                    earlyOvertime: earlyOvertimeNew.toFixed(2),
                    lateOvertime: lateOvertimeNew.toFixed(2),
                    overtimeConfirmed: overtimeConfirmedNew,
                    timestamp: startTime.getTime()
                };
            } else {
                const isWeekdayNew = selectedDate.getDay() >= 1 && selectedDate.getDay() <= 6;
                
                workData.unshift({
                    id: Date.now(),
                    date: formatDate(selectedDate),
                    dateISO: formatDateISO(startTime),
                    startTime: formatTime(startTime),
                    endTime: endTime ? formatTime(endTime) : null,
                    totalHours: workDuration.toFixed(2),
                    overtime: totalOvertime.toFixed(2),
                    manualOvertime: manualOvertime.toFixed(2),
                    lunchOvertime: lunchOvertime,
                    earlyOvertime: earlyOvertimeNew.toFixed(2),
                    lateOvertime: lateOvertimeNew.toFixed(2),
                    overtimeConfirmed: overtimeConfirmedNew,
                    timestamp: startTime.getTime(),
                    isWeekday: isWeekdayNew,
                    isAutoStarted: false
                });
            }
            
            saveDataToStorage();
            updateWorkHistory();
            renderCalendar(currentMonth, currentYear);
            hideDayModal();
            showNotification('Đã cập nhật giờ làm việc', 'success');
        }

        function createNewDayRecord(dateStr) {
            const date = parseDateString(dateStr);
            const isWeekdayNew = date.getDay() >= 1 && date.getDay() <= 6;
            
            const workRecord = {
                id: Date.now(),
                date: dateStr,
                dateISO: formatDateISO(date),
                startTime: '07:45',
                endTime: null,
                totalHours: '0.00',
                overtime: '0.00',
                manualOvertime: '0.00',
                lunchOvertime: 0,
                earlyOvertime: 0,
                lateOvertime: 0,
                overtimeConfirmed: false,
                timestamp: date.getTime(),
                isWeekday: isWeekdayNew,
                isAutoStarted: false
            };
            
            workData.unshift(workRecord);
            saveDataToStorage();
            updateWorkHistory();
            updateMonthSelect();
            initSalaryMonthSelect();
            showDayDetail(dateStr);
            showNotification('Đã tạo bản ghi mới cho ngày ' + dateStr, 'success');
        }

        function calculateSalary() {
            const basicSalaryInput = document.getElementById('basicSalary');
            const selectedMonthInput = document.getElementById('selectedMonth');
            
            const salary = parseInt(basicSalaryInput.value) || 0;
            const selectedMonthYear = selectedMonthInput.value;
            
            if (salary <= 0) {
                showNotification('Vui lòng nhập lương căn bản hợp lệ', 'warning');
                return;
            }
            
            if (!selectedMonthYear) {
                showNotification('Vui lòng chọn tháng', 'warning');
                return;
            }
            
            const [month, year] = selectedMonthYear.split('/').map(Number);
            
            const monthData = workData.filter(record => {
                const recordDate = new Date(record.timestamp);
                const recordMonth = recordDate.getMonth() + 1;
                const recordYear = recordDate.getFullYear();
                return recordMonth === month && recordYear === year && record.endTime;
            });
            
            let totalOvertimeHours = 0;
            let totalDays = 0;
            let detailHTML = '';
            
            monthData.forEach(record => {
                const overtime = parseFloat(record.overtime);
                if (overtime > 0) {
                    totalOvertimeHours += overtime;
                    totalDays++;
                    const earlyOvertime = parseFloat(record.earlyOvertime || 0);
                    const lateOvertime = parseFloat(record.lateOvertime || 0);
                    const lunchOvertime = record.lunchOvertime || 0;
                    
                    let detailText = `${overtime.toFixed(2)} giờ`;
                    let components = [];
                    if (earlyOvertime > 0) components.push(`sớm: ${earlyOvertime.toFixed(2)}h`);
                    if (lateOvertime > 0) components.push(`muộn: ${lateOvertime.toFixed(2)}h`);
                    if (lunchOvertime > 0) components.push(`trưa: ${lunchOvertime}h`);
                    
                    if (components.length > 0) {
                        detailText += ` (${components.join(', ')})`;
                    }
                    
                    detailHTML += `<div><span>${record.date}:</span><span>${detailText}</span></div>`;
                }
            });
            
            const dailySalary = salary / 26;
            const hourlySalary = dailySalary / 8;
            const overtimeRate = 2;
            const totalSalary = totalOvertimeHours * (hourlySalary * overtimeRate);
            
            const formattedSalary = formatCurrency(totalSalary);
            const formattedHourlySalary = formatCurrency(hourlySalary);
            
            document.getElementById('salaryAmount').textContent = formattedSalary;
            
            let details = `
                <div><span>Tổng giờ tăng ca:</span><span>${totalOvertimeHours.toFixed(2)} giờ</span></div>
                <div><span>Số ngày có tăng ca:</span><span>${totalDays} ngày</span></div>
                <div><span>Lương một giờ:</span><span>${formattedHourlySalary}/giờ</span></div>
                <div><span>Hệ số tăng ca:</span><span>${overtimeRate}</span></div>
            `;
            
            if (detailHTML) {
                details += `
                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.1);">
                        <div style="font-weight:600;margin-bottom:5px;">Chi tiết từng ngày:</div>
                        ${detailHTML}
                    </div>
                `;
            }
            
            document.getElementById('salaryDetails').innerHTML = details;
            document.getElementById('salaryResult').style.display = 'block';
            
            showNotification(`Đã tính lương tăng ca tháng ${month}/${year}`, 'success');
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', {
                style: 'currency',
                currency: 'VND'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            let bgColor = 'var(--primary)';
            if (type === 'success') bgColor = 'var(--success)';
            if (type === 'warning') bgColor = 'var(--warning)';
            if (type === 'danger') bgColor = 'var(--danger)';
            
            notification.style.backgroundColor = bgColor;
            notification.className = 'notification';
            notification.classList.add(type);
            messageElement.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        window.addEventListener('beforeunload', function(e) {
            if (isWorking) {
                e.preventDefault();
                e.returnValue = 'Bạn đang trong giờ làm việc. Bạn có chắc chắn muốn rời đi?';
            }
        });
    </script>
</body>
</html>
