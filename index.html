<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‚è±Ô∏è Ch·∫•m C√¥ng TƒÉng Ca - Auto Sync</title>
    <!-- C√°c th·∫ª meta v√† CSS gi·ªØ nguy√™n... -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Th√™m styles cho Google Drive Auto Sync */
        .sync-status {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background-color: rgba(66, 133, 244, 0.1);
            color: #4285F4;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 999;
            transition: all 0.3s;
        }
        .sync-status.syncing {
            background-color: rgba(255, 149, 0, 0.1);
            color: #FF9500;
        }
        .sync-status.success {
            background-color: rgba(52, 199, 89, 0.1);
            color: #34C759;
        }
        .sync-status.error {
            background-color: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
        }
        .google-signin-btn {
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            background-color: white;
            border: 1px solid #dadce0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .google-signin-btn:hover {
            background-color: #f8f9fa;
        }
        .drive-file-info {
            background-color: rgba(66, 133, 244, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <!-- Header v√† c√°c ph·∫ßn giao di·ªán gi·ªØ nguy√™n... -->
    
    <!-- Th√™m sync status indicator -->
    <div class="sync-status" id="syncStatus">
        <i class="fas fa-sync"></i>
        <span>Ch∆∞a k·∫øt n·ªëi Google Drive</span>
    </div>

    <!-- Th√™m modal Google Drive Auto Sync -->
    <div class="modal" id="googleDriveModal">
        <div class="modal-content">
            <h3>
                <i class="fab fa-google-drive"></i> ‚òÅÔ∏è Google Drive Auto Sync
                <button class="close-btn" id="closeGoogleDriveModal">&times;</button>
            </h3>
            
            <div id="driveSetupContent">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript -->
            </div>
        </div>
    </div>

    <!-- C√°c modal kh√°c gi·ªØ nguy√™n... -->

    <script>
        // ==================== GOOGLE DRIVE AUTO SYNC ====================
        
        // Bi·∫øn c·∫•u h√¨nh Google Drive
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyB3D2kL6n7Kj9JpP8qM5zXyVwT8uR1sT2v3', // Thay b·∫±ng API Key th·∫≠t
            clientId: 'YOUR_CLIENT_ID.apps.googleusercontent.com', // Thay b·∫±ng Client ID th·∫≠t
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            scope: 'https://www.googleapis.com/auth/drive.file'
        };
        
        // Bi·∫øn tr·∫°ng th√°i sync
        let isGoogleDriveEnabled = false;
        let googleDriveFileId = null;
        let lastSyncTime = null;
        let autoSyncInterval = null;
        let isSyncing = false;
        
        // Kh·ªüi t·∫°o Google Drive Auto Sync
        async function initGoogleDriveAutoSync() {
            try {
                // Ki·ªÉm tra n·∫øu ƒë√£ b·∫≠t auto sync
                const savedConfig = localStorage.getItem('chamcong_google_drive_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    isGoogleDriveEnabled = config.enabled || false;
                    googleDriveFileId = config.fileId || null;
                    lastSyncTime = config.lastSyncTime || null;
                    
                    if (isGoogleDriveEnabled) {
                        // Kh·ªüi t·∫°o Google API
                        await initGoogleAPI();
                        
                        // T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p n·∫øu c√≥ token
                        if (gapi.client.getToken()) {
                            startAutoSync();
                            updateSyncStatus('success', 'ƒê√£ k·∫øt n·ªëi Google Drive');
                        } else {
                            updateSyncStatus('error', 'Ch∆∞a ƒëƒÉng nh·∫≠p Google');
                        }
                    }
                }
                
                // C·∫≠p nh·∫≠t UI
                updateGoogleDriveUI();
                
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o Google Drive:', error);
            }
        }
        
        // Kh·ªüi t·∫°o Google API
        async function initGoogleAPI() {
            return new Promise((resolve, reject) => {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.apiKey,
                            discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
                        });
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }
        
        // X√°c th·ª±c Google
        function authenticateGoogle() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CONFIG.clientId,
                scope: GOOGLE_CONFIG.scope,
                callback: async (response) => {
                    if (response.error) {
                        updateSyncStatus('error', 'L·ªói ƒëƒÉng nh·∫≠p Google');
                        return;
                    }
                    
                    // L∆∞u config
                    isGoogleDriveEnabled = true;
                    saveGoogleDriveConfig();
                    
                    // Kh·ªüi ƒë·ªông auto sync
                    startAutoSync();
                    
                    // T√¨m ho·∫∑c t·∫°o file tr√™n Google Drive
                    await setupGoogleDriveFile();
                    
                    // T·∫£i d·ªØ li·ªáu t·ª´ Google Drive n·∫øu c√≥
                    await autoLoadFromGoogleDrive();
                    
                    updateSyncStatus('success', 'ƒê√£ k·∫øt n·ªëi Google Drive');
                    showNotification('‚úÖ ƒê√£ b·∫≠t Google Drive Auto Sync', 'success');
                }
            });
            
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        // Thi·∫øt l·∫≠p file tr√™n Google Drive
        async function setupGoogleDriveFile() {
            try {
                // T√¨m file ƒë√£ t·ªìn t·∫°i
                const response = await gapi.client.drive.files.list({
                    q: "name = 'chamcong_auto_backup.json' and trashed = false",
                    fields: 'files(id, name, modifiedTime)'
                });
                
                const files = response.result.files;
                
                if (files && files.length > 0) {
                    // D√πng file ƒë√£ t·ªìn t·∫°i
                    googleDriveFileId = files[0].id;
                    updateSyncStatus('success', `ƒêang ƒë·ªìng b·ªô v·ªõi Google Drive`);
                } else {
                    // T·∫°o file m·ªõi
                    await createGoogleDriveFile();
                }
                
                saveGoogleDriveConfig();
                
            } catch (error) {
                console.error('L·ªói thi·∫øt l·∫≠p file:', error);
            }
        }
        
        // T·∫°o file m·ªõi tr√™n Google Drive
        async function createGoogleDriveFile() {
            try {
                const fileMetadata = {
                    name: 'chamcong_auto_backup.json',
                    mimeType: 'application/json'
                };
                
                const response = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });
                
                googleDriveFileId = response.result.id;
                
                // Upload d·ªØ li·ªáu hi·ªán t·∫°i l√™n
                await autoSaveToGoogleDrive();
                
            } catch (error) {
                console.error('L·ªói t·∫°o file:', error);
            }
        }
        
        // T·ª± ƒë·ªông l∆∞u l√™n Google Drive
        async function autoSaveToGoogleDrive() {
            if (!isGoogleDriveEnabled || !googleDriveFileId || isSyncing) return;
            
            try {
                isSyncing = true;
                updateSyncStatus('syncing', 'ƒêang ƒë·ªìng b·ªô...');
                
                // Chu·∫©n b·ªã d·ªØ li·ªáu
                const exportData = {
                    workData: workData,
                    basicSalary: basicSalary,
                    exportDate: new Date().toISOString(),
                    appVersion: '3.0',
                    totalRecords: workData.length,
                    syncTime: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                
                // Update file tr√™n Google Drive
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: 'chamcong_auto_backup.json',
                    mimeType: 'application/json'
                })], { type: 'application/json' }));
                form.append('file', blob);
                
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${googleDriveFileId}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                    }),
                    body: form
                });
                
                // C·∫≠p nh·∫≠t th·ªùi gian sync
                lastSyncTime = new Date().toISOString();
                saveGoogleDriveConfig();
                
                updateSyncStatus('success', `ƒê√£ ƒë·ªìng b·ªô ${new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}`);
                
                // C·∫≠p nh·∫≠t last backup time
                saveBackupInfo();
                
            } catch (error) {
                console.error('L·ªói auto save:', error);
                updateSyncStatus('error', 'L·ªói ƒë·ªìng b·ªô');
            } finally {
                isSyncing = false;
            }
        }
        
        // T·ª± ƒë·ªông t·∫£i t·ª´ Google Drive khi m·ªü app
        async function autoLoadFromGoogleDrive() {
            if (!isGoogleDriveEnabled || !googleDriveFileId) return;
            
            try {
                updateSyncStatus('syncing', 'ƒêang t·∫£i d·ªØ li·ªáu...');
                
                // L·∫•y th√¥ng tin file
                const fileInfo = await gapi.client.drive.files.get({
                    fileId: googleDriveFileId,
                    fields: 'modifiedTime'
                });
                
                // Ki·ªÉm tra n·∫øu file tr√™n cloud m·ªõi h∆°n local
                const cloudModified = new Date(fileInfo.result.modifiedTime);
                const lastLocalSave = localStorage.getItem('chamcong_last_save_time');
                
                if (!lastLocalSave || cloudModified > new Date(lastLocalSave)) {
                    // T·∫£i file t·ª´ Google Drive
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${googleDriveFileId}?alt=media`, {
                        headers: new Headers({
                            'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                        })
                    });
                    
                    const cloudData = await response.json();
                    
                    // Merge d·ªØ li·ªáu (∆∞u ti√™n cloud n·∫øu m·ªõi h∆°n)
                    if (cloudData.workData && Array.isArray(cloudData.workData)) {
                        workData = mergeWorkData(workData, cloudData.workData);
                        
                        if (cloudData.basicSalary) {
                            basicSalary = cloudData.basicSalary;
                            document.getElementById('basicSalary').value = basicSalary;
                            localStorage.setItem('chamcong_basic_salary', basicSalary.toString());
                        }
                        
                        saveDataToStorage();
                        updateWorkHistory();
                        initSalaryMonthSelect();
                        
                        showNotification('‚úÖ ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Drive', 'success');
                    }
                }
                
                updateSyncStatus('success', 'D·ªØ li·ªáu ƒë√£ ƒë·ªìng b·ªô');
                
            } catch (error) {
                console.error('L·ªói auto load:', error);
                updateSyncStatus('error', 'L·ªói t·∫£i d·ªØ li·ªáu');
            }
        }
        
        // Merge d·ªØ li·ªáu t·ª´ cloud v√† local
        function mergeWorkData(localData, cloudData) {
            const mergedMap = new Map();
            
            // Th√™m t·∫•t c·∫£ t·ª´ cloud
            cloudData.forEach(item => {
                if (item.date && item.timestamp) {
                    mergedMap.set(item.date, item);
                }
            });
            
            // Th√™m t·ª´ local n·∫øu kh√¥ng tr√πng
            localData.forEach(item => {
                if (item.date && !mergedMap.has(item.date)) {
                    mergedMap.set(item.date, item);
                } else if (item.date) {
                    // N·∫øu tr√πng, ch·ªçn b·∫£n ghi m·ªõi h∆°n
                    const existing = mergedMap.get(item.date);
                    const existingTime = existing.timestamp || 0;
                    const localTime = item.timestamp || 0;
                    
                    if (localTime > existingTime) {
                        mergedMap.set(item.date, item);
                    }
                }
            });
            
            return Array.from(mergedMap.values())
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        }
        
        // B·∫Øt ƒë·∫ßu auto sync
        function startAutoSync() {
            if (autoSyncInterval) clearInterval(autoSyncInterval);
            
            // Sync m·ªói 2 ph√∫t
            autoSyncInterval = setInterval(async () => {
                if (isGoogleDriveEnabled && googleDriveFileId) {
                    await autoSaveToGoogleDrive();
                }
            }, 2 * 60 * 1000); // 2 ph√∫t
            
            // C≈©ng sync khi c√≥ thay ƒë·ªïi d·ªØ li·ªáu
            setupDataChangeListeners();
        }
        
        // L·∫Øng nghe thay ƒë·ªïi d·ªØ li·ªáu ƒë·ªÉ sync ngay l·∫≠p t·ª©c
        function setupDataChangeListeners() {
            // Monkey patch c√°c h√†m thay ƒë·ªïi d·ªØ li·ªáu
            const originalSaveWorkData = saveWorkData;
            saveWorkData = function(...args) {
                const result = originalSaveWorkData.apply(this, args);
                setTimeout(() => autoSaveToGoogleDrive(), 1000); // Sync sau 1 gi√¢y
                return result;
            };
            
            const originalSaveBasicSalary = saveBasicSalary;
            saveBasicSalary = function(...args) {
                const result = originalSaveBasicSalary.apply(this, args);
                setTimeout(() => autoSaveToGoogleDrive(), 1000);
                return result;
            };
            
            // L·∫Øng nghe c√°c s·ª± ki·ªán thay ƒë·ªïi
            document.addEventListener('workDataChanged', () => {
                setTimeout(() => autoSaveToGoogleDrive(), 1000);
            });
        }
        
        // L∆∞u config Google Drive
        function saveGoogleDriveConfig() {
            const config = {
                enabled: isGoogleDriveEnabled,
                fileId: googleDriveFileId,
                lastSyncTime: lastSyncTime,
                clientId: GOOGLE_CONFIG.clientId
            };
            localStorage.setItem('chamcong_google_drive_config', JSON.stringify(config));
        }
        
        // T·∫Øt Google Drive Auto Sync
        function disableGoogleDriveAutoSync() {
            isGoogleDriveEnabled = false;
            googleDriveFileId = null;
            
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            
            saveGoogleDriveConfig();
            updateSyncStatus('error', 'ƒê√£ t·∫Øt Google Drive Sync');
            updateGoogleDriveUI();
            
            showNotification('‚úÖ ƒê√£ t·∫Øt Google Drive Auto Sync', 'success');
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i sync
        function updateSyncStatus(status, message) {
            const syncStatusEl = document.getElementById('syncStatus');
            if (!syncStatusEl) return;
            
            syncStatusEl.className = 'sync-status';
            syncStatusEl.classList.add(status);
            
            const icon = syncStatusEl.querySelector('i');
            const text = syncStatusEl.querySelector('span');
            
            if (icon) {
                if (status === 'syncing') {
                    icon.className = 'fas fa-sync fa-spin';
                } else if (status === 'success') {
                    icon.className = 'fas fa-check-circle';
                } else if (status === 'error') {
                    icon.className = 'fas fa-exclamation-circle';
                } else {
                    icon.className = 'fas fa-cloud';
                }
            }
            
            if (text) {
                text.textContent = message;
            }
        }
        
        // C·∫≠p nh·∫≠t UI Google Drive
        function updateGoogleDriveUI() {
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                if (isGoogleDriveEnabled) {
                    backupBtn.innerHTML = `
                        <i class="fab fa-google-drive"></i> üíæ Google Drive (ƒêang b·∫≠t)
                    `;
                    backupBtn.style.backgroundColor = '#34C759';
                } else {
                    backupBtn.innerHTML = `
                        <i class="fas fa-database"></i> üíæ Sao L∆∞u & Kh√¥i Ph·ª•c
                    `;
                    backupBtn.style.backgroundColor = '';
                }
            }
        }
        
        // Hi·ªÉn th·ªã modal Google Drive
        function showGoogleDriveModal() {
            const modal = document.getElementById('googleDriveModal');
            const content = document.getElementById('driveSetupContent');
            
            if (isGoogleDriveEnabled) {
                content.innerHTML = `
                    <div class="drive-file-info">
                        <h4 style="color:#34C759;margin-bottom:10px;">
                            <i class="fas fa-check-circle"></i> Google Drive Auto Sync ƒêANG B·∫¨T
                        </h4>
                        <p>D·ªØ li·ªáu t·ª± ƒë·ªông ƒë·ªìng b·ªô m·ªói 2 ph√∫t</p>
                        <div style="margin-top:10px;font-size:14px;">
                            <div><strong>File:</strong> chamcong_auto_backup.json</div>
                            <div><strong>L·∫ßn ƒë·ªìng b·ªô cu·ªëi:</strong> ${lastSyncTime ? new Date(lastSyncTime).toLocaleString('vi-VN') : 'Ch∆∞a c√≥'}</div>
                            <div><strong>S·ªë b·∫£n ghi:</strong> ${workData.length}</div>
                        </div>
                    </div>
                    
                    <div style="margin:20px 0;">
                        <button class="btn btn-primary btn-full" onclick="manualSyncNow()">
                            <i class="fas fa-sync"></i> ƒê·ªìng b·ªô ngay
                        </button>
                    </div>
                    
                    <div style="margin:20px 0;">
                        <button class="btn btn-secondary btn-full" onclick="showDriveFileInfo()">
                            <i class="fas fa-info-circle"></i> Xem th√¥ng tin file
                        </button>
                    </div>
                    
                    <div style="margin:20px 0;">
                        <button class="btn btn-danger btn-full" onclick="disableGoogleDriveAutoSync()">
                            <i class="fas fa-power-off"></i> T·∫Øt Auto Sync
                        </button>
                    </div>
                    
                    <div style="padding:15px;background-color:rgba(52,199,89,0.1);border-radius:12px;margin-top:20px;">
                        <h4 style="color:var(--success);font-size:14px;">
                            <i class="fas fa-lightbulb"></i> Ho·∫°t ƒë·ªông t·ª± ƒë·ªông:
                        </h4>
                        <ul style="font-size:13px;padding-left:20px;margin:10px 0;">
                            <li>T·ª± l∆∞u khi c√≥ thay ƒë·ªïi d·ªØ li·ªáu</li>
                            <li>T·ª± t·∫£i khi m·ªü ·ª©ng d·ª•ng</li>
                            <li>ƒê·ªìng b·ªô gi·ªØa c√°c thi·∫øt b·ªã</li>
                            <li>L∆∞u l·ªãch s·ª≠ 30 ng√†y tr√™n cloud</li>
                        </ul>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <div style="font-size:60px;color:#4285F4;margin-bottom:20px;">
                            <i class="fab fa-google-drive"></i>
                        </div>
                        <h3 style="color:var(--dark);margin-bottom:10px;">
                            Google Drive Auto Sync
                        </h3>
                        <p style="color:var(--gray);margin-bottom:20px;">
                            B·∫≠t t√≠nh nƒÉng n√†y ƒë·ªÉ d·ªØ li·ªáu t·ª± ƒë·ªông ƒë·ªìng b·ªô l√™n Google Drive.
                            Kh√¥ng c·∫ßn thao t√°c th·ªß c√¥ng!
                        </p>
                        
                        <div style="background-color:rgba(66,133,244,0.1);border-radius:12px;padding:15px;margin:20px 0;">
                            <h4 style="color:#4285F4;margin-bottom:10px;">
                                <i class="fas fa-bolt"></i> L·ª£i √≠ch:
                            </h4>
                            <ul style="text-align:left;font-size:14px;padding-left:20px;">
                                <li>üíæ <strong>T·ª± ƒë·ªông sao l∆∞u</strong> m·ªói 2 ph√∫t</li>
                                <li>‚òÅÔ∏è <strong>ƒê·ªìng b·ªô ƒëa thi·∫øt b·ªã</strong> (iPhone, iPad, Android)</li>
                                <li>üîÑ <strong>Kh√¥i ph·ª•c t·ª± ƒë·ªông</strong> khi c√†i l·∫°i app</li>
                                <li>üîí <strong>An to√†n</strong> v·ªõi t√†i kho·∫£n Google c·ªßa b·∫°n</li>
                                <li>üìà <strong>L·ªãch s·ª≠ 30 ng√†y</strong> tr√™n cloud</li>
                            </ul>
                        </div>
                        
                        <button class="btn btn-primary btn-full" style="background-color:#4285F4;" onclick="authenticateGoogle()">
                            <i class="fab fa-google"></i> B·∫≠t Google Drive Auto Sync
                        </button>
                        
                        <div style="margin-top:20px;font-size:13px;color:var(--gray);">
                            <p><i class="fas fa-info-circle"></i> Ch·ªâ c·∫ßn ƒëƒÉng nh·∫≠p Google m·ªôt l·∫ßn</p>
                            <p><i class="fas fa-shield-alt"></i> ·ª®ng d·ª•ng ch·ªâ truy c·∫≠p file c·ªßa ch√≠nh n√≥</p>
                        </div>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }
        
        // ƒê·ªìng b·ªô ngay l·∫≠p t·ª©c
        async function manualSyncNow() {
            if (isGoogleDriveEnabled) {
                await autoSaveToGoogleDrive();
                showNotification('‚úÖ ƒê√£ ƒë·ªìng b·ªô ngay l·∫≠p t·ª©c', 'success');
            }
        }
        
        // Hi·ªÉn th·ªã th√¥ng tin file
        async function showDriveFileInfo() {
            try {
                const fileInfo = await gapi.client.drive.files.get({
                    fileId: googleDriveFileId,
                    fields: 'id,name,size,createdTime,modifiedTime,version'
                });
                
                const info = fileInfo.result;
                alert(`üìÅ Th√¥ng tin file tr√™n Google Drive:\n\n` +
                      `T√™n: ${info.name}\n` +
                      `K√≠ch th∆∞·ªõc: ${(parseInt(info.size) / 1024).toFixed(2)} KB\n` +
                      `T·∫°o l√∫c: ${new Date(info.createdTime).toLocaleString('vi-VN')}\n` +
                      `S·ª≠a l·∫ßn cu·ªëi: ${new Date(info.modifiedTime).toLocaleString('vi-VN')}\n` +
                      `Version: ${info.version || '1'}`);
                      
            } catch (error) {
                console.error('L·ªói l·∫•y th√¥ng tin file:', error);
            }
        }
        
        // ==================== INTEGRATION WITH EXISTING CODE ====================
        
        // C·∫≠p nh·∫≠t initApp ƒë·ªÉ kh·ªüi t·∫°o Google Drive Auto Sync
        const originalInitApp = initApp;
        initApp = async function() {
            await originalInitApp();
            await initGoogleDriveAutoSync();
            
            // Thay ƒë·ªïi s·ª± ki·ªán cho n√∫t backup
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                backupBtn.onclick = showGoogleDriveModal;
            }
            
            // Th√™m n√∫t ƒë√≥ng modal Google Drive
            document.getElementById('closeGoogleDriveModal').onclick = function() {
                document.getElementById('googleDriveModal').style.display = 'none';
            };
        };
        
        // Ghi ƒë√® h√†m saveDataToStorage ƒë·ªÉ trigger sync
        const originalSaveDataToStorage = saveDataToStorage;
        saveDataToStorage = function() {
            const result = originalSaveDataToStorage.apply(this, arguments);
            
            // K√≠ch ho·∫°t sync n·∫øu Google Drive ƒëang b·∫≠t
            if (isGoogleDriveEnabled && !isSyncing) {
                setTimeout(() => autoSaveToGoogleDrive(), 2000);
            }
            
            return result;
        };
        
        // Th√™m event khi c√≥ thay ƒë·ªïi d·ªØ li·ªáu
        function triggerWorkDataChanged() {
            const event = new Event('workDataChanged');
            document.dispatchEvent(event);
        }
        
        // C·∫≠p nh·∫≠t c√°c h√†m thay ƒë·ªïi d·ªØ li·ªáu ƒë·ªÉ trigger sync
        const functionsToPatch = [
            'saveWorkData',
            'updateDayTime',
            'createNewDayRecord',
            'confirmDeleteDay',
            'endWork',
            'startWork',
            'saveBasicSalary'
        ];
        
        functionsToPatch.forEach(funcName => {
            if (window[funcName]) {
                const originalFunc = window[funcName];
                window[funcName] = function(...args) {
                    const result = originalFunc.apply(this, args);
                    setTimeout(() => triggerWorkDataChanged(), 100);
                    return result;
                };
            }
        });
        
        // ==================== TEST CONFIG (CHO DEVELOPMENT) ====================
        
        // Config test cho localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            GOOGLE_CONFIG.apiKey = 'AIzaSyB3D2kL6n7Kj9JpP8qM5zXyVwT8uR1sT2v3'; // Test key
            GOOGLE_CONFIG.clientId = '1234567890-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com'; // Test client ID
            
            // Auto enable for testing
            window.addEventListener('load', () => {
                if (!localStorage.getItem('chamcong_google_drive_config')) {
                    console.log('Development mode: Google Drive test config loaded');
                    updateSyncStatus('error', 'Development Mode - Set up Google Drive');
                }
            });
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        
        // Format date for filename
        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // C√°c h√†m kh√°c gi·ªØ nguy√™n...
        
        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
