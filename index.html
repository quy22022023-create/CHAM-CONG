<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‚è±Ô∏è Ch·∫•m C√¥ng iOS</title>
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ch·∫•m C√¥ng">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Simple Manifest -->
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E2%8F%B1%EF%B8%8F%20Ch%E1%BA%A5m%20C%C3%B4ng%22%2C%22short_name%22%3A%22ChamCong%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23007AFF%22%2C%22theme_color%22%3A%22%23007AFF%22%7D">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ==================== RESET & BASE ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F2F2F7;
            color: #1D1D1F;
            line-height: 1.5;
            padding-bottom: env(safe-area-inset-bottom);
            padding-top: env(safe-area-inset-top);
        }
        
        /* SAFE AREAS */
        .safe-top {
            padding-top: env(safe-area-inset-top);
            background: linear-gradient(135deg, #007AFF, #5856D6);
            height: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
            height: env(safe-area-inset-bottom);
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 13px;
            font-weight: 400;
        }
        
        .day-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
            background-color: rgba(255,255,255,0.2);
        }
        
        .day-indicator.sunday {
            background-color: #FF2D55;
        }
        
        /* CURRENT TIME */
        .current-time {
            background-color: white;
            margin: 15px;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .current-time h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #007AFF;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .time-display {
            font-size: 32px;
            font-weight: 700;
            color: #1D1D1F;
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .date-display {
            font-size: 16px;
            color: #8E8E93;
            font-weight: 500;
        }
        
        /* CONTAINER & CARDS */
        .container {
            max-width: 100%;
            padding: 0 15px 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1D1D1F;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* BUTTONS */
        .btn {
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 10px;
            min-height: 44px;
        }
        
        .btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        
        .btn-start {
            background-color: #34C759;
        }
        
        .btn-end {
            background-color: #FF9500;
        }
        
        .btn-salary {
            background: linear-gradient(135deg, #5856D6, #7D3CFF);
        }
        
        .btn-backup {
            background-color: #FF9500;
        }
        
        .btn-month {
            background-color: #5AC8FA;
        }
        
        .btn-refresh {
            background-color: #5AC8FA;
        }
        
        .btn-supabase {
            background: linear-gradient(135deg, #3ECF8E, #3A86FF);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* CONTROLS */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* WORK INFO */
        .work-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .info-box {
            background-color: #F2F2F7;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .info-box h3 {
            font-size: 14px;
            color: #8E8E93;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 700;
            color: #1D1D1F;
        }
        
        /* HISTORY */
        .work-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #F2F2F7;
            cursor: pointer;
        }
        
        .history-date {
            font-weight: 600;
            font-size: 16px;
        }
        
        .history-time {
            font-size: 14px;
            color: #8E8E93;
        }
        
        .history-overtime {
            font-weight: 700;
            font-size: 16px;
            color: #34C759;
        }
        
        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #8E8E93;
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background-color: #34C759;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* STATUS */
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0,122,255,0.1);
            color: #007AFF;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 999;
            backdrop-filter: blur(10px);
        }
        
        .supabase-status {
            bottom: 60px;
            background-color: rgba(58,134,255,0.1);
            color: #3A86FF;
        }
        
        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* DARK MODE */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #000;
                color: #fff;
            }
            
            .card, .current-time {
                background-color: #1C1C1E;
            }
            
            .info-box {
                background-color: #2C2C2E;
            }
        }
    </style>
</head>
<body>
    <!-- SAFE AREAS -->
    <div class="safe-top"></div>
    
    <!-- HEADER -->
    <header class="header">
        <h1><i class="fas fa-clock"></i> ‚è±Ô∏è Ch·∫•m C√¥ng</h1>
        <p>‚è∞ 7:45 - 17:00 (T2-T7) | üéØ CN: To√†n b·ªô tƒÉng ca</p>
        <div class="day-indicator" id="dayIndicator">
            <i class="fas fa-calendar-day"></i> <span id="dayName">ƒêang t·∫£i...</span>
        </div>
    </header>
    
    <!-- CURRENT TIME -->
    <div class="current-time">
        <h2><i class="fas fa-calendar-alt"></i> üìÖ H√¥m nay</h2>
        <div class="date-display" id="currentDate">ƒêang t·∫£i...</div>
        <div class="time-display" id="currentTime">00:00:00</div>
        <div id="workStatus" style="color: #007AFF; font-weight: 600; margin-top: 5px;">
            üü° Ch∆∞a b·∫Øt ƒë·∫ßu l√†m vi·ªác
        </div>
    </div>
    
    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- CONTROL CARD -->
        <div class="card">
            <h2><i class="fas fa-play-circle"></i> üéÆ ƒêi·ªÅu khi·ªÉn</h2>
            <div class="controls">
                <button class="btn btn-start" id="startWorkBtn">
                    <i class="fas fa-play"></i> üöÄ B·∫Øt ƒë·∫ßu
                </button>
                <button class="btn btn-end" id="endWorkBtn">
                    <i class="fas fa-stop"></i> üèÅ Tan ca
                </button>
            </div>
            
            <div class="work-info">
                <div class="info-box">
                    <h3><i class="fas fa-sign-in-alt"></i> Gi·ªù b·∫Øt ƒë·∫ßu</h3>
                    <div class="info-value" id="startTime">--:--</div>
                </div>
                <div class="info-box">
                    <h3><i class="fas fa-sign-out-alt"></i> Gi·ªù k·∫øt th√∫c</h3>
                    <div class="info-value" id="endTime">--:--</div>
                </div>
                <div class="info-box">
                    <h3><i class="fas fa-clock"></i> T·ªïng th·ªùi gian</h3>
                    <div class="info-value" id="totalTime">0 gi·ªù</div>
                </div>
                <div class="info-box">
                    <h3><i class="fas fa-moon"></i> TƒÉng ca h√¥m nay</h3>
                    <div class="info-value" id="overtime">0 gi·ªù</div>
                </div>
            </div>
            
            <button class="btn btn-salary" id="salaryBtn">
                <i class="fas fa-calculator"></i> üßÆ T√≠nh L∆∞∆°ng TƒÉng Ca
            </button>
            
            <button class="btn btn-backup" id="backupBtn">
                <i class="fas fa-database"></i> üíæ Sao L∆∞u & Kh√¥i Ph·ª•c
            </button>
            
            <button class="btn btn-month" id="viewMonthBtn">
                <i class="fas fa-calendar-alt"></i> üìÖ Xem L·ªãch Th√°ng
            </button>
            
            <button class="btn btn-refresh" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> üîÑ Load L·∫°i D·ªØ Li·ªáu
            </button>
            
            <button class="btn btn-supabase" id="supabaseSyncBtn">
                <i class="fas fa-cloud"></i> ‚òÅÔ∏è ƒê·ªìng b·ªô Supabase
            </button>
        </div>
        
        <!-- HISTORY CARD -->
        <div class="card">
            <h2><i class="fas fa-history"></i> üìú L·ªãch s·ª≠ l√†m vi·ªác</h2>
            <div class="work-history" id="workHistory">
                <div style="text-align: center; padding: 30px; color: #8E8E93;">
                    <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SAFE AREA BOTTOM -->
    <div class="safe-bottom"></div>
    
    <!-- STATUS INDICATORS -->
    <div class="status" id="dataStatus">
        <i class="fas fa-database"></i> <span id="lastSaveTime">üü¢ ƒê√£ l∆∞u</span>
    </div>
    
    <div class="status supabase-status" id="supabaseStatus" style="display: none;">
        <i class="fas fa-cloud"></i> <span id="supabaseStatusText">Supabase: ƒêang ki·ªÉm tra...</span>
    </div>
    
    <!-- MODALS -->
    <div class="modal" id="salaryModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calculator"></i> T√≠nh L∆∞∆°ng
                <button class="close-btn" id="closeSalaryModal">&times;</button>
            </h3>
            <div id="salaryContent"></div>
        </div>
    </div>
    
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-database"></i> Sao L∆∞u & Kh√¥i Ph·ª•c
                <button class="close-btn" id="closeBackupModal">&times;</button>
            </h3>
            <div id="backupContent"></div>
        </div>
    </div>
    
    <div class="modal" id="monthCalendarModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-calendar"></i> L·ªãch Th√°ng
                <button class="close-btn" id="closeMonthModal">&times;</button>
            </h3>
            <div id="monthCalendar"></div>
        </div>
    </div>
    
    <div class="modal" id="editTimeModal">
        <div class="modal-content">
            <h3>
                <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a gi·ªù l√†m
                <button class="close-btn" id="closeEditModal">&times;</button>
            </h3>
            <div id="editTimeContent"></div>
        </div>
    </div>
    
    <!-- NOTIFICATION -->
    <div class="notification" id="notification">
        <div id="notificationMessage">‚úÖ Thao t√°c th√†nh c√¥ng!</div>
    </div>
    
    <script>
        // ==================== C·∫§U H√åNH SUPABASE ====================
        const SUPABASE_URL = 'https://awxkvzkigfxoidnvmxew.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3eGt2emtpZ2Z4b2lkbnZteGV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzUwNTcsImV4cCI6MjA4NTg1MTA1N30.eBGQc3rp9-H4ipsCDhUdLTC7aJB6HHDh6CKwsvV9b3A';
        
        // ==================== BI·∫æN TO√ÄN C·ª§C ====================
        let supabase = null;
        let isSupabaseConnected = false;
        let workData = [];
        let basicSalary = 0;
        let today = new Date();
        let workStartTime = null;
        let workEndTime = null;
        let isWorking = false;
        let timerInterval = null;
        let autoStartTriggered = false;
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        
        // ==================== KH·ªûI ƒê·ªòNG ·ª®NG D·ª§NG ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ ·ª®ng d·ª•ng ƒëang kh·ªüi ƒë·ªông...');
            
            // Kh·ªüi t·∫°o Supabase
            await initSupabase();
            
            // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
            initTime();
            loadAllData();
            setupEventListeners();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o
            setTimeout(() => {
                showNotification('‚úÖ ·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng!');
            }, 500);
        });
        
        // ==================== SUPABASE FUNCTIONS ====================
        async function initSupabase() {
            try {
                updateSupabaseStatus('üîÑ ƒêang k·∫øt n·ªëi...');
                
                // T·∫°o Supabase client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test connection
                const { data, error } = await supabase
                    .from('work_records')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('L·ªói k·∫øt n·ªëi Supabase:', error);
                    updateSupabaseStatus('‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c');
                    return false;
                }
                
                isSupabaseConnected = true;
                updateSupabaseStatus('‚úÖ ƒê√£ k·∫øt n·ªëi');
                
                // T·∫£i d·ªØ li·ªáu t·ª´ Supabase
                await loadFromSupabase();
                
                return true;
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o Supabase:', error);
                updateSupabaseStatus('‚ùå L·ªói kh·ªüi t·∫°o');
                return false;
            }
        }
        
        async function loadFromSupabase() {
            if (!isSupabaseConnected) return;
            
            try {
                updateSupabaseStatus('üîÑ ƒêang t·∫£i d·ªØ li·ªáu...');
                
                const { data, error } = await supabase
                    .from('work_records')
                    .select('*')
                    .order('work_date', { ascending: false });
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu Supabase
                    const supabaseData = data.map(record => ({
                        id: record.id,
                        date: formatDate(new Date(record.work_date)),
                        startTime: record.start_time,
                        endTime: record.end_time,
                        totalHours: record.total_hours?.toString() || '0',
                        overtime: record.overtime?.toString() || '0',
                        timestamp: new Date(record.work_date).getTime(),
                        isWeekday: record.is_weekday || false,
                        lunchOvertime: record.lunch_overtime || false
                    }));
                    
                    // H·ª£p nh·∫•t d·ªØ li·ªáu
                    workData = mergeData(workData, supabaseData);
                    saveLocalData();
                    updateHistory();
                    
                    updateSupabaseStatus(`‚úÖ ƒê√£ t·∫£i ${data.length} b·∫£n ghi`);
                    showNotification(`‚òÅÔ∏è ƒê√£ t·∫£i ${data.length} b·∫£n ghi t·ª´ ƒë√°m m√¢y`);
                }
            } catch (error) {
                console.error('L·ªói t·∫£i t·ª´ Supabase:', error);
            }
        }
        
        async function saveToSupabase() {
            if (!isSupabaseConnected || workData.length === 0) return false;
            
            try {
                updateSupabaseStatus('üîÑ ƒêang l∆∞u l√™n ƒë√°m m√¢y...');
                
                const recordsToSave = workData.map(record => ({
                    work_date: new Date(record.timestamp).toISOString().split('T')[0],
                    start_time: record.startTime,
                    end_time: record.endTime,
                    total_hours: parseFloat(record.totalHours) || 0,
                    overtime: parseFloat(record.overtime) || 0,
                    is_weekday: record.isWeekday || false,
                    lunch_overtime: record.lunchOvertime || false
                }));
                
                const { error } = await supabase
                    .from('work_records')
                    .upsert(recordsToSave, { onConflict: 'work_date' });
                
                if (error) throw error;
                
                updateSupabaseStatus('‚úÖ ƒê√£ l∆∞u l√™n ƒë√°m m√¢y');
                return true;
            } catch (error) {
                console.error('L·ªói l∆∞u l√™n Supabase:', error);
                updateSupabaseStatus('‚ùå L·ªói l∆∞u d·ªØ li·ªáu');
                return false;
            }
        }
        
        function mergeData(localData, cloudData) {
            const merged = [...localData];
            
            cloudData.forEach(cloudRecord => {
                const existingIndex = merged.findIndex(local => local.date === cloudRecord.date);
                if (existingIndex === -1) {
                    merged.push(cloudRecord);
                } else {
                    // ∆Øu ti√™n d·ªØ li·ªáu m·ªõi h∆°n
                    if (cloudRecord.timestamp > merged[existingIndex].timestamp) {
                        merged[existingIndex] = cloudRecord;
                    }
                }
            });
            
            // S·∫Øp x·∫øp theo th·ªùi gian
            return merged.sort((a, b) => b.timestamp - a.timestamp);
        }
        
        function updateSupabaseStatus(text) {
            const status = document.getElementById('supabaseStatus');
            const textEl = document.getElementById('supabaseStatusText');
            
            if (status && textEl) {
                textEl.textContent = text;
                status.style.display = 'flex';
            }
        }
        
        // ==================== CORE FUNCTIONS ====================
        function initTime() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }
        
        function updateCurrentTime() {
            const now = new Date();
            today = now;
            
            const dateStr = now.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const timeStr = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
            
            // C·∫≠p nh·∫≠t th·ª©
            const dayNames = ['Ch·ªß nh·∫≠t', 'Th·ª© hai', 'Th·ª© ba', 'Th·ª© t∆∞', 'Th·ª© nƒÉm', 'Th·ª© s√°u', 'Th·ª© b·∫£y'];
            const dayName = dayNames[today.getDay()];
            document.getElementById('dayName').textContent = dayName;
            
            // Ki·ªÉm tra t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu
            checkAutoStart();
        }
        
        async function startWork() {
            if (isWorking) {
                showNotification('‚ö†Ô∏è B·∫°n ƒë√£ b·∫Øt ƒë·∫ßu l√†m vi·ªác!');
                return;
            }
            
            workStartTime = new Date();
            isWorking = true;
            
            document.getElementById('startTime').textContent = formatTime(workStartTime);
            document.getElementById('workStatus').textContent = 'üü¢ ƒêang l√†m vi·ªác';
            document.getElementById('workStatus').style.color = '#34C759';
            
            startTimer();
            updateButtonStates();
            
            // L∆∞u v√†o Supabase
            if (isSupabaseConnected) {
                await saveCurrentWorkToSupabase();
            }
            
            showNotification('üöÄ ƒê√£ b·∫Øt ƒë·∫ßu l√†m vi·ªác');
        }
        
        async function endWork() {
            if (!isWorking) {
                showNotification('‚ö†Ô∏è B·∫°n ch∆∞a b·∫Øt ƒë·∫ßu l√†m vi·ªác!');
                return;
            }
            
            workEndTime = new Date();
            isWorking = false;
            
            stopTimer();
            
            const totalHours = calculateTotalHours(workStartTime, workEndTime);
            const overtimeHours = calculateOvertime(workStartTime, workEndTime);
            
            document.getElementById('endTime').textContent = formatTime(workEndTime);
            document.getElementById('totalTime').textContent = totalHours.toFixed(2) + ' gi·ªù';
            document.getElementById('overtime').textContent = overtimeHours.toFixed(2) + ' gi·ªù';
            document.getElementById('workStatus').textContent = 'üü° ƒê√£ tan ca';
            document.getElementById('workStatus').style.color = '#FF9500';
            
            updateButtonStates();
            
            // L∆∞u b·∫£n ghi
            const record = saveWorkRecord(workStartTime, workEndTime, totalHours, overtimeHours);
            
            // L∆∞u v√†o Supabase
            if (isSupabaseConnected) {
                await saveRecordToSupabase(record);
            }
            
            showNotification(`üèÅ ƒê√£ tan ca. TƒÉng ca: ${overtimeHours.toFixed(2)} gi·ªù`);
        }
        
        async function saveCurrentWorkToSupabase() {
            if (!isSupabaseConnected) return;
            
            try {
                const record = {
                    work_date: today.toISOString().split('T')[0],
                    start_time: formatTime(workStartTime),
                    end_time: null,
                    total_hours: 0,
                    overtime: 0,
                    is_weekday: (today.getDay() >= 1 && today.getDay() <= 6),
                    lunch_overtime: false
                };
                
                const { error } = await supabase
                    .from('work_records')
                    .upsert([record], { onConflict: 'work_date' });
                
                if (error) throw error;
            } catch (error) {
                console.error('L·ªói l∆∞u c√¥ng vi·ªác hi·ªán t·∫°i:', error);
            }
        }
        
        async function saveRecordToSupabase(record) {
            if (!isSupabaseConnected) return;
            
            try {
                const supabaseRecord = {
                    work_date: new Date(record.timestamp).toISOString().split('T')[0],
                    start_time: record.startTime,
                    end_time: record.endTime,
                    total_hours: parseFloat(record.totalHours),
                    overtime: parseFloat(record.overtime),
                    is_weekday: record.isWeekday,
                    lunch_overtime: record.lunchOvertime || false
                };
                
                const { error } = await supabase
                    .from('work_records')
                    .upsert([supabaseRecord], { onConflict: 'work_date' });
                
                if (error) throw error;
            } catch (error) {
                console.error('L·ªói l∆∞u b·∫£n ghi:', error);
            }
        }
        
        function checkAutoStart() {
            if (autoStartTriggered || today.getDay() === 0 || today.getDay() === 6) return;
            
            const now = new Date();
            if (now.getHours() === 7 && now.getMinutes() >= 45) {
                autoStartWork();
            }
        }
        
        function autoStartWork() {
            autoStartTriggered = true;
            
            const startTime = new Date(today);
            startTime.setHours(7, 45, 0, 0);
            
            workStartTime = startTime;
            isWorking = true;
            
            document.getElementById('startTime').textContent = '07:45';
            document.getElementById('workStatus').textContent = 'üü¢ ƒêang l√†m vi·ªác (t·ª± ƒë·ªông)';
            
            startTimer();
            updateButtonStates();
            
            showNotification('ü§ñ T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu l√†m vi·ªác l√∫c 7:45');
        }
        
        function updateButtonStates() {
            const startBtn = document.getElementById('startWorkBtn');
            const endBtn = document.getElementById('endWorkBtn');
            
            if (isWorking) {
                startBtn.disabled = true;
                endBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                endBtn.disabled = true;
            }
        }
        
        // ==================== CALCULATION FUNCTIONS ====================
        function calculateTotalHours(start, end) {
            const diffMs = end - start;
            return diffMs / (1000 * 60 * 60);
        }
        
        function calculateOvertime(start, end) {
            // Ch·ªß nh·∫≠t: to√†n b·ªô l√† tƒÉng ca
            if (today.getDay() === 0) {
                return calculateTotalHours(start, end);
            }
            
            let overtime = 0;
            
            // Tr∆∞·ªõc 7:45
            const standardStart = new Date(start);
            standardStart.setHours(7, 45, 0, 0);
            if (start < standardStart) {
                overtime += calculateTotalHours(start, standardStart);
            }
            
            // Sau 17:00
            const standardEnd = new Date(start);
            standardEnd.setHours(17, 0, 0, 0);
            if (end > standardEnd) {
                overtime += calculateTotalHours(standardEnd, end);
            }
            
            return overtime;
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('vi-VN');
        }
        
        // ==================== TIMER ====================
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (workStartTime && isWorking) {
                    const now = new Date();
                    const totalHours = calculateTotalHours(workStartTime, now);
                    const overtimeHours = calculateOvertime(workStartTime, now);
                    
                    document.getElementById('totalTime').textContent = totalHours.toFixed(2) + ' gi·ªù';
                    document.getElementById('overtime').textContent = overtimeHours.toFixed(2) + ' gi·ªù';
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // ==================== DATA MANAGEMENT ====================
        function saveWorkRecord(startTime, endTime, totalHours, overtimeHours) {
            const record = {
                id: Date.now(),
                date: formatDate(today),
                startTime: formatTime(startTime),
                endTime: formatTime(endTime),
                totalHours: totalHours.toFixed(2),
                overtime: overtimeHours.toFixed(2),
                timestamp: startTime.getTime(),
                isWeekday: (today.getDay() >= 1 && today.getDay() <= 6),
                lunchOvertime: false
            };
            
            // Ki·ªÉm tra n·∫øu ƒë√£ c√≥ b·∫£n ghi h√¥m nay
            const existingIndex = workData.findIndex(r => r.date === record.date);
            if (existingIndex >= 0) {
                workData[existingIndex] = record;
            } else {
                workData.unshift(record);
            }
            
            saveLocalData();
            updateHistory();
            
            return record;
        }
        
        function saveLocalData() {
            try {
                localStorage.setItem('chamcong_work_data', JSON.stringify(workData));
                localStorage.setItem('chamcong_basic_salary', basicSalary.toString());
                updateSaveTime();
            } catch (error) {
                console.error('L·ªói l∆∞u d·ªØ li·ªáu:', error);
            }
        }
        
        function loadAllData() {
            try {
                // Load work data
                const savedData = localStorage.getItem('chamcong_work_data');
                if (savedData) {
                    workData = JSON.parse(savedData);
                }
                
                // Load salary
                const savedSalary = localStorage.getItem('chamcong_basic_salary');
                if (savedSalary) {
                    basicSalary = parseInt(savedSalary) || 0;
                }
                
                updateHistory();
                checkTodayStatus();
                updateSaveTime();
            } catch (error) {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                workData = [];
            }
        }
        
        function checkTodayStatus() {
            const todayStr = formatDate(today);
            const todayRecord = workData.find(record => record.date === todayStr);
            
            if (todayRecord) {
                document.getElementById('startTime').textContent = todayRecord.startTime;
                
                if (todayRecord.endTime) {
                    document.getElementById('endTime').textContent = todayRecord.endTime;
                    document.getElementById('totalTime').textContent = todayRecord.totalHours + ' gi·ªù';
                    document.getElementById('overtime').textContent = todayRecord.overtime + ' gi·ªù';
                    document.getElementById('workStatus').textContent = 'üü° ƒê√£ tan ca';
                } else {
                    workStartTime = new Date(todayRecord.timestamp);
                    isWorking = true;
                    document.getElementById('workStatus').textContent = 'üü¢ ƒêang l√†m vi·ªác';
                    startTimer();
                }
            }
            
            updateButtonStates();
        }
        
        function updateHistory() {
            const historyContainer = document.getElementById('workHistory');
            
            if (workData.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #8E8E93;">
                        <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            workData.forEach(record => {
                html += `
                    <div class="history-item" onclick="showEditModal('${record.date}')">
                        <div>
                            <div class="history-date">
                                ${record.isWeekday ? 'üìÖ' : 'üéØ'} ${record.date}
                            </div>
                            <div class="history-time">
                                ${record.startTime} - ${record.endTime || '--:--'}
                            </div>
                        </div>
                        <div class="history-overtime">
                            ${record.endTime ? `üí∞ +${record.overtime}h` : 'üü¢ ƒêang l√†m'}
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = html;
        }
        
        function updateSaveTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastSaveTime').textContent = `L∆∞u: ${timeStr}`;
        }
        
        // ==================== MODAL FUNCTIONS ====================
        function showSalaryModal() {
            const content = `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">L∆∞∆°ng th√°ng (VNƒê)</label>
                    <input type="number" id="salaryInput" value="${basicSalary || ''}" 
                           style="width: 100%; padding: 12px; border: 2px solid #F2F2F7; border-radius: 8px; font-size: 16px;"
                           placeholder="Nh·∫≠p l∆∞∆°ng th√°ng">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ªçn th√°ng</label>
                    <select id="monthSelect" style="width: 100%; padding: 12px; border: 2px solid #F2F2F7; border-radius: 8px; font-size: 16px;">
                        <option value="">Ch·ªçn th√°ng...</option>
                    </select>
                </div>
                
                <button class="btn btn-salary" onclick="calculateSalary()" style="margin-top: 0;">
                    <i class="fas fa-calculator"></i> T√≠nh L∆∞∆°ng
                </button>
                
                <div id="salaryResult" style="margin-top: 20px; padding: 15px; background: #F2F2F7; border-radius: 8px; display: none;"></div>
            `;
            
            document.getElementById('salaryContent').innerHTML = content;
            document.getElementById('salaryModal').style.display = 'flex';
            
            populateMonthSelect();
        }
        
        function populateMonthSelect() {
            const select = document.getElementById('monthSelect');
            const months = new Set();
            
            workData.forEach(record => {
                const date = new Date(record.timestamp);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                months.add(monthYear);
            });
            
            select.innerHTML = '<option value="">Ch·ªçn th√°ng...</option>';
            months.forEach(monthYear => {
                const [month, year] = monthYear.split('/');
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = `Th√°ng ${month}/${year}`;
                select.appendChild(option);
            });
        }
        
        function calculateSalary() {
            const salaryInput = document.getElementById('salaryInput');
            const salary = parseInt(salaryInput.value) || 0;
            const monthYear = document.getElementById('monthSelect').value;
            
            if (!salary || !monthYear) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }
            
            // L∆∞u l∆∞∆°ng
            basicSalary = salary;
            localStorage.setItem('chamcong_basic_salary', salary.toString());
            
            const [month, year] = monthYear.split('/').map(Number);
            
            // L·ªçc d·ªØ li·ªáu
            const monthData = workData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate.getMonth() + 1 === month && 
                       recordDate.getFullYear() === year &&
                       record.endTime;
            });
            
            // T√≠nh l∆∞∆°ng
            let totalOvertime = 0;
            monthData.forEach(record => {
                totalOvertime += parseFloat(record.overtime) || 0;
            });
            
            const hourlySalary = (salary / 26 / 8) * 2; // L∆∞∆°ng tƒÉng ca/gi·ªù
            const totalSalary = totalOvertime * hourlySalary;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const resultDiv = document.getElementById('salaryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h4 style="margin-bottom: 10px;">K·∫øt qu·∫£ t√≠nh l∆∞∆°ng</h4>
                <div style="font-size: 24px; font-weight: 700; color: #5856D6; margin: 10px 0;">
                    ${formatCurrency(totalSalary)}
                </div>
                <div style="font-size: 14px; color: #8E8E93;">
                    <div>T·ªïng gi·ªù tƒÉng ca: <strong>${totalOvertime.toFixed(2)} gi·ªù</strong></div>
                    <div>S·ªë ng√†y: <strong>${monthData.length} ng√†y</strong></div>
                    <div>L∆∞∆°ng th√°ng: <strong>${formatCurrency(salary)}</strong></div>
                </div>
            `;
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', {
                style: 'currency',
                currency: 'VND'
            });
        }
        
        function showBackupModal() {
            const content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: #8E8E93; margin-bottom: 20px;">
                        T·ªïng: <strong>${workData.length}</strong> b·∫£n ghi
                    </p>
                </div>
                
                <button class="btn" onclick="exportData()" style="background-color: #34C759;">
                    <i class="fas fa-file-export"></i> Xu·∫•t d·ªØ li·ªáu
                </button>
                
                <button class="btn" onclick="importData()" style="background-color: #007AFF; margin-top: 10px;">
                    <i class="fas fa-file-import"></i> Nh·∫≠p d·ªØ li·ªáu
                </button>
                
                <div style="margin-top: 20px; padding: 15px; background: #F2F2F7; border-radius: 8px;">
                    <p style="font-size: 14px; color: #8E8E93; text-align: center;">
                        <i class="fas fa-info-circle"></i> D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o file JSON
                    </p>
                </div>
            `;
            
            document.getElementById('backupContent').innerHTML = content;
            document.getElementById('backupModal').style.display = 'flex';
        }
        
        function exportData() {
            try {
                const backupData = {
                    workData: workData,
                    basicSalary: basicSalary,
                    timestamp: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `chamcong_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng');
                hideModal('backupModal');
            } catch (error) {
                showNotification('‚ùå L·ªói xu·∫•t d·ªØ li·ªáu');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.workData) {
                            throw new Error('File kh√¥ng h·ª£p l·ªá');
                        }
                        
                        if (confirm(`Nh·∫≠p ${backupData.workData.length} b·∫£n ghi? D·ªØ li·ªáu c≈© s·∫Ω ƒë∆∞·ª£c th√™m v√†o.`)) {
                            workData = [...backupData.workData, ...workData];
                            if (backupData.basicSalary) {
                                basicSalary = backupData.basicSalary;
                            }
                            
                            saveLocalData();
                            updateHistory();
                            
                            // ƒê·ªìng b·ªô l√™n Supabase
                            if (isSupabaseConnected) {
                                saveToSupabase();
                            }
                            
                            showNotification(`‚úÖ ƒê√£ nh·∫≠p ${backupData.workData.length} b·∫£n ghi`);
                            hideModal('backupModal');
                        }
                    } catch (error) {
                        showNotification('‚ùå File kh√¥ng h·ª£p l·ªá');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function showMonthCalendar() {
            renderCalendar();
            document.getElementById('monthCalendarModal').style.display = 'flex';
        }
        
        function renderCalendar() {
            const monthNames = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
                               'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: 600;">${monthNames[currentMonth]} ${currentYear}</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="prevMonth()" style="padding: 8px; background: #F2F2F7; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="todayMonth()" style="padding: 8px 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            H√¥m nay
                        </button>
                        <button onclick="nextMonth()" style="padding: 8px; background: #F2F2F7; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px; text-align: center;">
                    <div>CN</div><div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
            `;
            
            // Ng√†y tr·ªëng ƒë·∫ßu th√°ng
            for (let i = 0; i < firstDayIndex; i++) {
                html += `<div style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center;"></div>`;
            }
            
            // C√°c ng√†y trong th√°ng
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = formatDate(date);
                const isToday = date.toDateString() === today.toDateString();
                const dayData = workData.find(record => record.date === dateStr);
                
                let style = 'aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer;';
                
                if (isToday) {
                    style += 'background: rgba(0,122,255,0.1); color: #007AFF; font-weight: 700;';
                } else if (dayData) {
                    style += 'background: rgba(52,199,89,0.1);';
                }
                
                html += `
                    <div style="${style}" onclick="showEditModal('${dateStr}')">
                        ${day}
                        ${dayData && parseFloat(dayData.overtime) > 0 ? 
                          `<div style="font-size: 10px; color: #34C759;">+${parseFloat(dayData.overtime).toFixed(1)}h</div>` : ''}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            document.getElementById('monthCalendar').innerHTML = html;
        }
        
        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }
        
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }
        
        function todayMonth() {
            const now = new Date();
            currentMonth = now.getMonth();
            currentYear = now.getFullYear();
            renderCalendar();
        }
        
        function showEditModal(dateStr) {
            const dayData = workData.find(record => record.date === dateStr);
            
            let content = '';
            
            if (dayData) {
                content = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>${dateStr}</h3>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>Gi·ªù b·∫Øt ƒë·∫ßu</label>
                        <input type="time" id="editStartTime" value="${dayData.startTime}" 
                               style="width: 100%; padding: 12px; border: 2px solid #F2F2F7; border-radius: 8px; margin-top: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>Gi·ªù k·∫øt th√∫c</label>
                        <input type="time" id="editEndTime" value="${dayData.endTime || ''}" 
                               style="width: 100%; padding: 12px; border: 2px solid #F2F2F7; border-radius: 8px; margin-top: 5px;">
                    </div>
                    
                    <button class="btn" onclick="saveEditedTime('${dateStr}')" style="background-color: #34C759;">
                        <i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi
                    </button>
                    
                    <button class="btn" onclick="deleteRecord('${dateStr}')" style="background-color: #FF3B30; margin-top: 10px;">
                        <i class="fas fa-trash"></i> X√≥a b·∫£n ghi
                    </button>
                `;
            } else {
                content = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>T·∫°o b·∫£n ghi m·ªõi</h3>
                        <p style="color: #8E8E93;">${dateStr}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>Gi·ªù b·∫Øt ƒë·∫ßu</label>
                        <input type="time" id="editStartTime" value="07:45" 
                               style="width: 100%; padding: 12px; border: 2px solid #F2F2F7; border-radius: 8px; margin-top: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>Gi·ªù k·∫øt th√∫c</label>
                        <input type="time" id="editEndTime" value="17:00" 
                               style="width: 100%; padding: 12px; border: 2px solid #F2F2F7; border-radius: 8px; margin-top: 5px;">
                    </div>
                    
                    <button class="btn" onclick="saveNewRecord('${dateStr}')" style="background-color: #007AFF;">
                        <i class="fas fa-plus"></i> T·∫°o b·∫£n ghi
                    </button>
                `;
            }
            
            document.getElementById('editTimeContent').innerHTML = content;
            document.getElementById('editTimeModal').style.display = 'flex';
        }
        
        async function saveEditedTime(dateStr) {
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            
            if (!startTime) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p gi·ªù b·∫Øt ƒë·∫ßu');
                return;
            }
            
            const date = parseDate(dateStr);
            const startDate = new Date(date);
            const [startHour, startMinute] = startTime.split(':');
            startDate.setHours(startHour, startMinute, 0, 0);
            
            let totalHours = 0;
            let overtime = 0;
            
            if (endTime) {
                const endDate = new Date(date);
                const [endHour, endMinute] = endTime.split(':');
                endDate.setHours(endHour, endMinute, 0, 0);
                
                totalHours = calculateTotalHours(startDate, endDate);
                overtime = calculateOvertime(startDate, endDate);
            }
            
            const record = {
                id: Date.now(),
                date: dateStr,
                startTime: startTime,
                endTime: endTime || null,
                totalHours: totalHours.toFixed(2),
                overtime: overtime.toFixed(2),
                timestamp: startDate.getTime(),
                isWeekday: (date.getDay() >= 1 && date.getDay() <= 6),
                lunchOvertime: false
            };
            
            const index = workData.findIndex(r => r.date === dateStr);
            if (index >= 0) {
                workData[index] = record;
            } else {
                workData.unshift(record);
            }
            
            saveLocalData();
            updateHistory();
            
            // L∆∞u v√†o Supabase
            if (isSupabaseConnected) {
                await saveRecordToSupabase(record);
            }
            
            showNotification('‚úÖ ƒê√£ c·∫≠p nh·∫≠t b·∫£n ghi');
            hideModal('editTimeModal');
        }
        
        function saveNewRecord(dateStr) {
            saveEditedTime(dateStr);
        }
        
        async function deleteRecord(dateStr) {
            if (!confirm(`X√≥a b·∫£n ghi ng√†y ${dateStr}?`)) return;
            
            const index = workData.findIndex(r => r.date === dateStr);
            if (index >= 0) {
                workData.splice(index, 1);
                saveLocalData();
                updateHistory();
                
                // X√≥a kh·ªèi Supabase
                if (isSupabaseConnected) {
                    try {
                        const date = parseDate(dateStr);
                        const isoDate = date.toISOString().split('T')[0];
                        
                        const { error } = await supabase
                            .from('work_records')
                            .delete()
                            .eq('work_date', isoDate);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('L·ªói x√≥a t·ª´ Supabase:', error);
                    }
                }
                
                showNotification('üóëÔ∏è ƒê√£ x√≥a b·∫£n ghi');
                hideModal('editTimeModal');
            }
        }
        
        function parseDate(dateStr) {
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function refreshData() {
            loadAllData();
            showNotification('üîÑ ƒê√£ l√†m m·ªõi d·ªØ li·ªáu');
        }
        
        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Control buttons
            document.getElementById('startWorkBtn').addEventListener('click', startWork);
            document.getElementById('endWorkBtn').addEventListener('click', endWork);
            
            // Modal buttons
            document.getElementById('salaryBtn').addEventListener('click', showSalaryModal);
            document.getElementById('backupBtn').addEventListener('click', showBackupModal);
            document.getElementById('viewMonthBtn').addEventListener('click', showMonthCalendar);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('supabaseSyncBtn').addEventListener('click', async () => {
                if (isSupabaseConnected) {
                    await saveToSupabase();
                } else {
                    showNotification('‚ùå Ch∆∞a k·∫øt n·ªëi Supabase');
                }
            });
            
            // Close buttons
            document.getElementById('closeSalaryModal').addEventListener('click', () => hideModal('salaryModal'));
            document.getElementById('closeBackupModal').addEventListener('click', () => hideModal('backupModal'));
            document.getElementById('closeMonthModal').addEventListener('click', () => hideModal('monthCalendarModal'));
            document.getElementById('closeEditModal').addEventListener('click', () => hideModal('editTimeModal'));
            
            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideModal(this.id);
                    }
                });
            });
            
            // Auto-save
            setInterval(() => {
                saveLocalData();
            }, 30000);
            
            // Save before unload
            window.addEventListener('beforeunload', () => {
                saveLocalData();
            });
        }
    </script>
</body>
</html>
